<i>This guide is divided into two parts, port forwarding and port tunneling. This post covers port forwarding only.</i><br /><br /><a href="#10">1. Introduction</a><br /><a href="#20">2. Requirements</a><br /><a href="#30">3. Assumptions </a><br /><a href="#40">4. Setup Before Port Forwarding</a><br /><a href="#41">&nbsp;&nbsp;&nbsp; 4.1 Setting up Apache server</a><br /><a href="#42">&nbsp;&nbsp;&nbsp; 4.2 Configuring iptables</a><br /><a href="#50">5. Setup After Port Forwarding</a><br /><a href="#51">&nbsp; &nbsp; 5.1 Dataflow </a><br /><a href="#52">&nbsp;&nbsp;&nbsp; 5.2 Rinetd on proxy machine</a><br /><a href="#60">6. Did it work?</a><br /><a href="#70">7. No love for Windows?</a><br /><h2 id="10">1. Introduction</h2>During my preparation for the PWK/OSCP course (starting late January), I had a hard time understanding how port forwarding/tunneling works. Most guides I found were too theoretical for my taste, this guide will allow you to mimic a strict corporate firewall and how to bypass it.<br /><br />So what is port forwarding? It's a technique that allows you to redirect traffic from one port to another port/IP. What the hell does that mean?<br /><br />Imagine the following scenario:<br /><br />Your corp firewall only allows outbound connections to web servers  running on standard ports (<i>port 80 for HTTP / port 443 for HTTPS</i>). Your favorite security news website for some reason is run on <i>port 8000</i>. Given the strict corp firewall you won't be able to browse the site any more.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/WaYeE8F.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/WaYeE8F.png" height="339" width="800" /></a></div><br />You decide to use your knowledge of port forwarding to still be able to browse your favorite site. We'll be using <a href="http://www.lenzg.net/rinetd/rinetd.html">rinetd </a>as TCP forwarder.<br /><h2 id="20">2. Requirements</h2>To follow this guide you'll need the following:<br /><ul><li>Host machine capable of running 2 Linux VMs.</li><li>LAN network.</li><li>Some patience.</li></ul><h2 id="30">3. Assumptions</h2>All machines are on the same network for simplicity, thus no router configuration is needed.<br /><br /><table border="3"><tbody><tr>     <th>Machine</th>     <th>IP</th> </tr><tr>     <td>abatchy-work</td>     <td>192.168.20.130</td> </tr><tr>     <td>abatchy-proxy</td>     <td>192.168.20.131</td> </tr><tr>     <td>abatchy-http</td>     <td>192.168.20.132</td> </tr></tbody></table>&nbsp;<b>&nbsp;</b><br /><ul><li><b>192.168.20.130: </b>Work machine, ideally it's behind a NAT and firewalled. For simplicity it's in the same LAN and iptables is used instead.<b>&nbsp;&nbsp; </b></li></ul><ul><li><b>192.168.20.131:</b> Home machine, used as proxy to forward inbound traffic on port 80 to 192.168.20.132 on port 8000.</li></ul><ul><li><b>192.168.20.132:</b> Web server running your favorite site on non-standard port 8000, inaccessible directly from your work machine because of firewall.</li></ul><h2 id="40">4. Setup Before Port Forwarding</h2>We'll be configuring the following setup:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/wKZcLPV.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/wKZcLPV.jpg" height="282" width="640" /></a></div><br /><h4 id="41">4.1 Setting up Apache server</h4><h4>&nbsp;</h4>We'll start by setting up our Apache server on 192.168.20.132 (Web server)<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;"><span style="color: #6aa84f;"><span style="color: #aaaaaa;">// Install Apache server</span></span></span><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-http:~$</span> sudo apt-get install apache2<br /><br /><span style="color: #6aa84f;"><span style="color: #6aa84f;"><span style="color: #aaaaaa;">// Change default port Apache is listening on to 8000</span></span></span><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-http:~$</span> sudo nano /etc/apache2/ports.conf</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;"><span style="color: #aaaaaa;">// Change virtual host from</span><br /><span style="color: #aaaaaa;"><span style="color: #6aa84f;">//</span> </span></span><span style="color: #6aa84f;"><span style="color: #aaaaaa;"><span style="color: #330099; font-weight: bold;">&lt;VirtualHost</span> <span style="color: #cc3300;">*:80</span><span style="color: #330099; font-weight: bold;">&gt;</span></span><br /><span style="color: #aaaaaa;">// to</span><br /><span style="color: #aaaaaa;"><span style="color: #6aa84f;">//</span> </span></span><span style="color: #330099; font-weight: bold;">&lt;VirtualHost</span> <span style="color: #cc3300;">*:8000</span><span style="color: #330099; font-weight: bold;">&gt;</span><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-</span><span style="color: #000099; font-weight: bold;"><span style="color: #000099; font-weight: bold;">http</span>:~$</span> sudo nano /etc/apache2/sites-enabled/000-default&nbsp;</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;"><span style="color: #6aa84f;">/<span style="color: #aaaaaa;">/ Restart Apache server</span></span></span><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-http:~$</span> sudo service restart apache2 </pre></div><br />Now let's verify it's working as expected.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;"><span style="color: #aaaaaa;">// sudo is needed since netstat won't show processes not owned by abatchy</span></span><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-http:~$</span> sudo netstat -antp | grep apache2<br /><br /><span style="color: #aaaaaa;">tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN      4523/apache2  </span><br /></pre></div><br /><h4 id="42">4.2 Configuring iptables</h4><br />Next, we'll configure iptables on 192.168.20.130 (work machine) to drop any outgoing traffic except for ones using TCP port 80 and 443.<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;"><span style="color: #6aa84f;">// </span></span><span style="color: #6aa84f;">Verify that there are no rules defined yet</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> sudo iptables -L<br /><span style="color: #aaaaaa;">[sudo] password for abatchy:</span><br /><br /><span style="color: #aaaaaa;">Chain INPUT (policy ACCEPT)</span><br /><span style="color: #aaaaaa;">target     prot opt source               destination        </span><br /><br /><span style="color: #aaaaaa;">Chain FORWARD (policy ACCEPT)</span><br /><span style="color: #aaaaaa;">target     prot opt source               destination        </span><br /><br /><span style="color: #aaaaaa;">Chain OUTPUT (policy ACCEPT)</span><br /><span style="color: #aaaaaa;">target     prot opt source               destination</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0;"></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;">// Block all traffic</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> sudo iptables -I OUTPUT -j DROP</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;">// Allow outbound traffic on port 80</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> sudo iptables -I OUTPUT -p tcp --dport 80 -j ACCEPT</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;">// Allow outbound traffic on port 443</span> </pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> sudo iptables -I OUTPUT -p tcp --dport 443 -j ACCEPT</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;">// View current rules defined</span> </pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> sudo iptables -L<br /><br /><span style="color: #aaaaaa;">Chain INPUT (policy ACCEPT)</span><br /><span style="color: #aaaaaa;">target     prot opt source               destination        </span><br /><br /><span style="color: #aaaaaa;">Chain FORWARD (policy ACCEPT)</span><br /><span style="color: #aaaaaa;">target     prot opt source               destination        </span><br /><br /><span style="color: #aaaaaa;">Chain OUTPUT (policy ACCEPT)</span><br /><span style="color: #aaaaaa;">target     prot opt source               destination        </span><br /><b><span style="color: #aaaaaa;">ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https</span><br /><span style="color: #aaaaaa;">ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http</span></b><br /><span style="color: #aaaaaa;">DROP       all  --  anywhere             anywhere           </span><br /><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> <br /></pre></div><br />Notice the order the rules were applied. <b>-I </b>was used to put the rules on top of the chain, thus overriding the "block all traffic" rule. One more thing is that you can't make DNS requests / resolve URLs since UDP port 53 is included in the rule.<br /><br />Next, let's ensure that the current rules work properly.<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> wget http://192.168.20.132:8000<br /><span style="color: #aaaaaa;">--2017-01-12 03:01:24--  http://192.168.20.132:8000/</span><br /><span style="color: #aaaaaa;">Connecting to 192.168.20.132:8000... ^C</span><br /><span style="color: #000099; font-weight: bold;">abatchy@abatchy-work:~$</span> <br /></pre></div><br />As expected, we're not able to connect to <b>http://192.168.20.132:8000</b>. In case you want to see logs of the dropped packets check <a href="http://www.thegeekstuff.com/2012/08/iptables-log-packets/?utm_source=feedburner">this</a>. <br /><h2 id="50">5. Setup After Port Forwarding</h2><h4 id="51">5.1 Data flow</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/6AVblX5.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/6AVblX5.jpg" height="310" width="640" /></a></div><b>(1) </b>Outgoing traffic to <b>192.168.20.131:80</b>, which our firewall will let through to our switch.<br /><b>(2) </b>On our proxy machine, we will have <b>rinetd </b>listening on port 80.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/bnmdfJ7.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/bnmdfJ7.jpg" height="328" width="640" /></a></div><br /><br /><b>(3) and (4)</b> Traffic is forwarded by rinetd to our webserver, listening on <b>192.168.20.132:8000</b><br /><b>(5) and (6)</b> Web server replies back to our proxy machine.<br /><b>(7)</b> Proxy replies back to our work machine, traffic still flowing as it's on port 80.<br /><br /><h4 id="52">5.2 Rinetd on proxy machine</h4><h4 id="52">&nbsp;</h4>Rinetd is a very light-weight, simple-to-use TCP forwarder, we will set it up so it redirects incoming traffic on port 80 to <b>192.168.20.132:8000</b> (our web server).<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;"><span style="color: #6aa84f;">// Install rinetd </span></span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">abatchy@abatchy-proxy:/home$</span> sudo apt-get install rinetd</pre><pre style="line-height: 125%; margin: 0;">&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #6aa84f;">// Add the following rule below the comment </span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">abatchy@abatchy-proxy:/home$</span> sudo nano /etc/rinetd.conf <br /><span style="color: navy; font-weight: bold;">#</span> bindadress    bindport  connectaddress  connectport<br /><span style="color: #888888;">192.168.20.131  80      192.168.20.132  8000</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">&nbsp;</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;"><span style="color: #6aa84f;">// Restart the service</span>&nbsp;</span><br /><span style="color: navy; font-weight: bold;">abatchy@abatchy-proxy:/home$</span> sudo service rinetd restart<br /></pre></div><br /><h2 id="60">6. Did it work?</h2><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">abatchy@abatchy-work:~$</span> wget http://192.168.20.131:80<br /><span style="color: #888888;">--2017-01-12 19:56:35--  http://192.168.20.131/</span><br /><span style="color: #888888;">Connecting to 192.168.20.131:80... connected.</span><br /><span style="color: #888888;">HTTP request sent, awaiting response... 200 OK</span><br /><span style="color: #888888;">Length: 20 [text/html]</span><br /><span style="color: #888888;">Saving to: ‘index.html’</span><br /><br /><span style="color: #888888;">100%[======================================&gt;] 20          --.-K/s   in 0s      </span><br /><br /><span style="color: #888888;">2017-01-12 19:56:35 (6.33 MB/s) - ‘index.html’ saved [20/20]</span><br /><br /><span style="color: navy; font-weight: bold;">abatchy@abatchy-work:~$</span> cat index.html <br /><span style="color: #888888;">Super cool website!</span><br /><span style="color: navy; font-weight: bold;">abatchy@abatchy-work:~$</span> <br /></pre></div><br />It worked! A wireshark capture below on the proxy shows the traffic flow.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/q5IJ378.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/q5IJ378.png" height="334" width="640" /></a></div><b><br /></b> <b>2266-2268:</b> Three way handshake between Work and Proxy:80.<br /><b>2269-2270:</b> GET request and ACK.<br /><b>2271-2273:</b> Three way handshake between Proxy and WebServer:8000.<br /><b>2274-2275:</b> GET request and ACK<br /><b>2276-2277:</b> WebServer responds and Proxy acknowledges.<br /><b>2278-2279:</b> Proxy forwards received packet back to Work.<br /><b>2280-2285:</b> Work terminates connection with Proxy and Proxy terminates connection with WebServer.<br /><h2 id="70">7. No love for Windows?</h2>Rinetd supports Windows and is pretty straight-forward as on Linux as well. Binary can be found <a href="https://www.boutell.com/rinetd/">here</a>.<br /><br />Assuming rinetd is installed in: <b>C:\rinetd</b>, just add the same rule to <b>rinetd.conf:</b><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #aaaaaa;">192.168.20.131  80      192.168.20.132  8000</span><br /></pre></div><br />Then run rinetd:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #003333;">C:\rinetd&gt;rinetd.exe</span> <span style="color: #003333;">-c</span> <span style="color: #003333;">rinetd.conf</span><br /></pre></div><br />And done.<br /><hr /><br /><br />Hopefully this guide sheds some light on port forwarding and more advanced traffic manipulation. Part two will discuss port tunneling.<br /><br /><i>Currently listening to:<a href="https://www.youtube.com/watch?v=IVdtIR4ZOKU"> Dark Sanctuary – Les Mémoires Blessées</a></i> 