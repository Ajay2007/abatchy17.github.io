<i>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</i><br /><i> </i><i><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/" target="_blank">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></i><br /><i> </i><i><b>Student ID:</b>&nbsp;SLAE-885</i><br /><i><b>Assignment number: </b>5.3</i><br /><i><b>Github repo:</b> <a href="https://github.com/abatchy17/SLAE">https://github.com/abatchy17/SLAE</a>&nbsp; </i><br /><br />In the third and final part of assignment 5 in SLAE, I'll be analyzing the linux/x86/exec module using Ndisasm.<br /><br />Ndisasm comes with Nasm assembler, unlike GDB and Libemu it doesn't execute any code, just converts shellcode to the corresponding instructions, so we'll be analyzing the instructions by hand.<br /><br /><h2>1. Setting payload parameters</h2><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> msfvenom -p linux/x86/exec --payload-options<br /><span style="color: black; font-style: italic;">Options for payload/linux/x86/exec:</span><br /><br /><br /><span style="color: black; font-style: italic;">       Name: Linux Execute Command</span><br /><span style="color: black; font-style: italic;">     Module: payload/linux/x86/exec</span><br /><span style="color: black; font-style: italic;">   Platform: Linux</span><br /><span style="color: black; font-style: italic;">       Arch: x86</span><br /><span style="color: black; font-style: italic;">Needs Admin: No</span><br /><span style="color: black; font-style: italic;"> Total size: 36</span><br /><span style="color: black; font-style: italic;">       Rank: Normal</span><br /><br /><span style="color: black; font-style: italic;">Provided by:</span><br /><span style="color: black; font-style: italic;">    vlad902 &lt;vlad902@gmail.com&gt;</span><br /><br /><span style="color: black; font-style: italic;">Basic options:</span><br /><span style="color: black; font-style: italic;">Name  Current Setting  Required  Description</span><br /><span style="color: black; font-style: italic;">----  ---------------  --------  -----------</span><br /><span style="color: black; font-style: italic;">CMD                    yes       The command string to execute</span><br /><br /><span style="color: black; font-style: italic;">Description:</span><br /><span style="color: black; font-style: italic;">  Execute an arbitrary command</span><br /></pre></div><br />Payload requires a single command, so let's use something simple like <b>/bin/date</b>.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> msfvenom -p linux/x86/exec <span style="color: black;">CMD</span><span style="color: #ce5c00; font-weight: bold;">=</span>/bin/date -f c<br /><span style="color: black; font-style: italic;">No platform was selected, choosing Msf::Module::Platform::Linux from the payload</span><br /><span style="color: black; font-style: italic;">No Arch selected, selecting Arch: x86 from the payload</span><br /><span style="color: black; font-style: italic;">No encoder or badchars specified, outputting raw payload</span><br /><span style="color: black; font-style: italic;">Payload size: 45 bytes</span><br /><span style="color: black; font-style: italic;">Final size of c file: 213 bytes</span><br /><span style="color: black; font-style: italic;">unsigned char buf[] = </span><br /><span style="color: black; font-style: italic;">"\x6a\x0b\x58\x99\x52\x66\x68\x2d\x63\x89\xe7\x68\x2f\x73\x68"</span><br /><span style="color: black; font-style: italic;">"\x00\x68\x2f\x62\x69\x6e\x89\xe3\x52\xe8\x0a\x00\x00\x00\x2f"</span><br /><span style="color: black; font-style: italic;">"\x62\x69\x6e\x2f\x64\x61\x74\x65\x00\x57\x53\x89\xe1\xcd\x80";</span><br /></pre></div><br /><h2>2. Analyzing payload with Ndisasm</h2><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> <span style="color: #204a87;">echo</span> -ne <span style="color: #4e9a06;">"\x6a\x0b\x58\x99\x52\x66\x68\x2d\x63\x89\xe7\x68\x2f\x73\x68\x00\x68\x2f\x62\x69\x6e\x89\xe3\x52\xe8\x0a\x00\x00\x00\x2f\x62\x69\x6e\x2f\x64\x61\x74\x65\x00\x57\x53\x89\xe1\xcd\x80"</span> | ndisasm -u -<br /></pre></div><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #008c00;">00000000</span>  6A0B              <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">+</span><span style="color: #00a800;">0xb</span><br /><span style="color: #008c00;">00000002</span>  <span style="color: #008c00;">58</span>                <span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span><br /><span style="color: #008c00;">00000003</span>  <span style="color: #008c00;">99</span>                <span style="color: #e66170; font-weight: bold;">cdq</span><br /><span style="color: #008c00;">00000004</span>  <span style="color: #008c00;">52</span>                <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edx</span><br /><span style="color: #008c00;">00000005</span>  66682D6<span style="color: #008c00;">3</span>          <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">word</span> <span style="color: #00a800;">0x632d</span><br /><span style="color: #008c00;">00000009</span>  <span style="color: #008c00;">89</span><span style="color: #006600;">E7</span>              <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">edi</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span><br /><span style="color: #007d00;">0000000B</span>  682F7<span style="color: #008c00;">36800</span>        <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">dword</span> <span style="color: #00a800;">0x68732f</span><br /><span style="color: #008c00;">00000010</span>  682F62696E        <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">dword</span> <span style="color: #00a800;">0x6e69622f</span><br /><span style="color: #008c00;">00000015</span>  <span style="color: #008c00;">89</span><span style="color: #006600;">E3</span>              <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ebx</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span><br /><span style="color: #008c00;">00000017</span>  <span style="color: #008c00;">52</span>                <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edx</span><br /><span style="color: #008c00;">00000018</span>  E80A0<span style="color: #008c00;">00000</span>        <span style="color: #e66170; font-weight: bold;">call</span> <span style="color: #e34adc;">dword</span> <span style="color: #00a800;">0x27</span><br /><span style="color: #008c00;">0000001D</span>  2F                <span style="color: #e66170; font-weight: bold;">das</span><br />0000001E  62696E            <span style="color: #e66170; font-weight: bold;">bound</span> <span style="color: #d0d09f;">ebp</span><span style="color: #d2cd86;">,</span><span style="color: #d2cd86;">[</span><span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">+</span><span style="color: #00a800;">0x6e</span><span style="color: #d2cd86;">]</span><br /><span style="color: #008c00;">00000021</span>  2F                <span style="color: #e66170; font-weight: bold;">das</span><br /><span style="color: #008c00;">00000022</span>  <span style="color: #008c00;">6461</span>              <span style="color: #d0d09f;">fs</span> <span style="color: #e66170; font-weight: bold;">popad</span><br /><span style="color: #008c00;">00000024</span>  <span style="color: #008c00;">7465</span>              <span style="color: #e66170; font-weight: bold;">jz</span> <span style="color: #e34adc;">0x8b</span><br /><span style="color: #008c00;">00000026</span>  <span style="color: #008c00;">005753</span>            <span style="color: #e66170; font-weight: bold;">add</span> <span style="color: #d2cd86;">[</span><span style="color: #d0d09f;">edi</span><span style="color: #d2cd86;">+</span><span style="color: #00a800;">0x53</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">dl</span><br /><span style="color: #008c00;">00000029</span>  <span style="color: #008c00;">89</span><span style="color: #006600;">E1</span>              <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span><br />0000002B  CD8<span style="color: #008c00;">0</span>              <span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">0x80</span><br /></pre>Okay let's go through every few commands and get an idea what's going on.<br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">+</span><span style="color: #00a800;">0xb</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span>                 <span style="color: #9999a9;">; EAX = 0xb</span><br /><span style="color: #e66170; font-weight: bold;">cdq</span>                     <span style="color: #9999a9;">; Extend EAX -&gt; EDX = 0x0</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edx</span>                <span style="color: #9999a9;">; Push zero byte</span><br /></pre><br />Nothing special here so far.<br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">word</span> <span style="color: #00a800;">0x632d</span>        <span style="color: #9999a9;">; Translates to "-c"</span><br /><span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">edi</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span>             <span style="color: #9999a9;">; Make EDI point to top of stack, which contains "-c" terminated with a null character</span><br /></pre><br />This part is constructing the command to be executed, <b>-c </b>will execute the command.<br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">dword</span> <span style="color: #00a800;">0x68732f</span>     <span style="color: #9999a9;">; PUSH "hs/"</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">dword</span> <span style="color: #00a800;">0x6e69622f</span>   <span style="color: #9999a9;">; PUSH "nib/"</span><br /><span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ebx</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span>             <span style="color: #9999a9;">; Make EBX point to top of stack "/bin/sh -c"</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edx</span>                <span style="color: #9999a9;">; Push another NULL byte</span><br /></pre><br />Next part is interesting, code tells us to jump to instruction <b>27</b>, but there isn't one! Reason is that there is a string starting at <b>1D till 27.</b><br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~#</span> <span style="color: #204a87;">echo</span> -ne <span style="color: #4e9a06;">"\x2f\x62\x69\x6e\x2f\x64\x61\x74\x65\x00"</span><br /><span style="color: black; font-style: italic;">/bin/date</span><br /></pre></div><br />Remaining instructions (after 27) are interpreted incorrectly, so let's pipe them again to ndisasm and come up with the correct instructions.<br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e34adc;">oot@kali:</span><span style="color: #d2cd86;">~</span># <span style="color: #008073;">echo</span> <span style="color: #d2cd86;">-</span><span style="color: #008073;">ne</span> <span style="color: #00c4c4;">"\x57\x53\x89\xe1\xcd\x80"</span> <span style="color: #d2cd86;">|</span> ndisasm <span style="color: #d2cd86;">-</span>u <span style="color: #d2cd86;">-</span><br /><span style="color: #008c00;">00000000</span>  <span style="color: #008c00;">57</span>                <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edi</span><br /><span style="color: #008c00;">00000001</span>  <span style="color: #008c00;">53</span>                <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">ebx</span><br /><span style="color: #008c00;">00000002</span>  <span style="color: #008c00;">89</span><span style="color: #006600;">E1</span>              <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span><br /><span style="color: #008c00;">00000004</span>  CD8<span style="color: #008c00;">0</span>              <span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">0x80</span><br /></pre><br />Awesome, this makes more sense now. Let's rewrite the assembly code in a more understandable structure.<br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #008c00;">00000000</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">+</span><span style="color: #00a800;">0xb</span><br /><span style="color: #008c00;">00000002</span>    <span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span>                 <span style="color: #9999a9;">; EAX = 0xb</span><br /><span style="color: #008c00;">00000003</span>    <span style="color: #e66170; font-weight: bold;">cdq</span>                     <span style="color: #9999a9;">; Extend EAX -&gt; EDX = 0x0</span><br /><span style="color: #008c00;">00000004</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edx</span>                <span style="color: #9999a9;">; Push zero byte</span><br /><span style="color: #008c00;">00000005</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">word</span> <span style="color: #00a800;">0x632d</span>        <span style="color: #9999a9;">; Translates to "-c"</span><br /><span style="color: #008c00;">00000009</span>    <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">edi</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span>             <span style="color: #9999a9;">; Make EDI point to top of stack, which contains "-c" terminated with a null character</span><br /><span style="color: #007d00;">0000000B</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">dword</span> <span style="color: #00a800;">0x68732f</span>     <span style="color: #9999a9;">; PUSH "hs/"</span><br /><span style="color: #008c00;">00000010</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">dword</span> <span style="color: #00a800;">0x6e69622f</span>   <span style="color: #9999a9;">; PUSH "nib/"</span><br /><span style="color: #008c00;">00000015</span>    <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ebx</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span>             <span style="color: #9999a9;">; Make EBX point to top of stack "/bin/sh"</span><br /><span style="color: #008c00;">00000017</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edx</span>                <span style="color: #9999a9;">; Push another NULL byte</span><br /><span style="color: #008c00;">00000018</span>    <span style="color: #e66170; font-weight: bold;">call</span> <span style="color: #e34adc;">dword</span> <span style="color: #00a800;">0x27</span>         <span style="color: #9999a9;">; Address of "/bin/date" is pushed onto stack through "call"</span><br /><span style="color: #008c00;">0000001D</span>    <span style="color: #00c4c4;">"/bin/date"</span>             <span style="color: #9999a9;">; Not executed</span><br /><span style="color: #008c00;">00000027</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">edi</span>                <span style="color: #9999a9;">; Push pointer to "-c"</span><br /><span style="color: #008c00;">00000027</span>    <span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #d0d09f;">ebx</span>                <span style="color: #9999a9;">; Push pointer to "/bin/sh"</span><br /><span style="color: #008c00;">00000029</span>    <span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">esp</span>             <span style="color: #9999a9;">; ECX point to top of stack</span><br />                                    <span style="color: #9999a9;">; This is the "meat" of the shellcode, ECX points to [addr1][addr2][addr3][null]</span><br />                                    <span style="color: #9999a9;">; addr1 points to /bin/sh (0B, 10 and 15)</span><br />                                    <span style="color: #9999a9;">; addr2 points to -c (05 and 09)</span><br />                                    <span style="color: #9999a9;">; addr3 points to "/bin/date" (18 and 1D)</span><br /><br />                                    <span style="color: #9999a9;">; NULL indicates end of argv[]</span><br />0000002B    <span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">0x80</span>                <span style="color: #9999a9;">; EAX = 0xb, which is syscall for execve()</span><br />                                    <span style="color: #9999a9;">; EBX points to argv[0]</span><br />                                    <span style="color: #9999a9;">; ECX points to &amp;argv[0]</span><br /></pre><br /><h3>TL;DR</h3><br />1. EAX is set to 0xb<b>, </b>which is the syscall number for <b>execve()</b><br />2. EBX points to <b>"/bin/sh"</b><br />3. ECX points to argv[]<b> </b>which is<b> { "/bin/sh", "-c", "/bin/date" }&nbsp;</b><br /><br />That's it!<br /><br />- Abatchy